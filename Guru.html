<!DOCTYPE html>
<html lang="id" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Guru - Smart CBT</title>
    <style>
        :root { --bg-body: #f8fafc; --bg-card: #ffffff; --text-main: #0f172a; --text-sub: #64748b; --border: #e2e8f0; --input-bg: #ffffff; --primary: #2563eb; --success: #10b981; --danger: #ef4444; }
        [data-theme="dark"] { --bg-body: #0f172a; --bg-card: #1e293b; --text-main: #f1f5f9; --text-sub: #94a3b8; --border: #334155; --input-bg: #0f172a; }
        
        html, body { height: 100%; margin: 0; }
        body { font-family: 'Inter', sans-serif; background: var(--bg-body); color: var(--text-main); display: flex; flex-direction: column; transition: 0.3s; }

        header { background: var(--bg-card); display: flex; align-items: center; justify-content: space-between; padding: 15px 30px; border-bottom: 1px solid var(--border); position: sticky; top: 0; z-index: 1000; }
        
        .container { flex: 1; max-width: 1100px; width: 100%; margin: 20px auto; padding: 0 20px; box-sizing: border-box; }
        .card { background: var(--bg-card); padding: 25px; border-radius: 20px; border: 1px solid var(--border); margin-bottom: 30px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        
        .tabs { display: flex; gap: 10px; margin-bottom: 25px; background: var(--bg-card); padding: 8px; border-radius: 15px; border: 1px solid var(--border); }
        .tab-btn { flex: 1; padding: 12px; border: none; background: transparent; color: var(--text-sub); cursor: pointer; font-weight: 600; border-radius: 10px; transition: 0.3s; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .tab-btn.active { background: var(--primary); color: white; }

        input, select, textarea { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid var(--border); border-radius: 10px; background: var(--input-bg); color: var(--text-main); box-sizing: border-box; outline: none; }
        label { font-size: 0.75rem; font-weight: 700; color: var(--text-sub); text-transform: uppercase; display: block; margin-top: 15px; }

        /* Area Ceklis Rapat */
        .area-kls-check { background: var(--input-bg); border: 1px solid var(--border); border-radius: 10px; padding: 12px; max-height: 150px; overflow-y: auto; display: grid; grid-template-columns: repeat(3, 1fr); gap: 5px; margin-top: 10px; }
        .check-item { display: flex; align-items: center; gap: 4px; font-size: 0.85rem; cursor: pointer; }
        .check-item input { width: auto; margin: 0; cursor: pointer; }

        .btn { padding: 12px 20px; border: none; border-radius: 10px; cursor: pointer; font-weight: 600; transition: 0.3s; }
        .btn-success { background: var(--success); color: white; width: 100%; margin-top: 20px; }
        .btn-danger { background: var(--danger); color: white; font-size: 0.75rem; padding: 6px 12px; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th { color: var(--primary); text-align: left; padding: 12px; border-bottom: 2px solid var(--border); font-size: 0.8rem; }
        td { padding: 12px; border-bottom: 1px solid var(--border); font-size: 0.9rem; }
        
        footer { background: var(--bg-card); border-top: 1px solid var(--border); padding: 15px 20px; text-align: center; color: var(--text-sub); font-size: 0.8rem; }
        .footer-brand { font-weight: 700; color: var(--primary); margin-bottom: 2px; }

        /* Custom Modal */
        #customModal { display: none; position: fixed; z-index: 9999; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); backdrop-filter: blur(5px); }
        .modal-content { background: var(--bg-card); margin: 15vh auto; padding: 25px; border: 1px solid var(--border); width: 90%; max-width: 400px; border-radius: 20px; text-align: center; box-shadow: 0 20px 40px rgba(0,0,0,0.4); animation: slideIn 0.3s ease-out; }
        @keyframes slideIn { from { transform: translateY(-20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .modal-btns { display: flex; gap: 10px; justify-content: center; margin-top: 20px; }
        .btn-modal { padding: 10px 25px; border-radius: 10px; cursor: pointer; font-weight: 600; border: none; }
    </style>
</head>
<body>

<header>
    <div style="font-weight: 800; font-size: 1.3rem; color: var(--primary);">Smart CBT - Guru</div>
    <div style="font-size: 0.75rem; color: var(--success); font-weight: 600;">‚óè Server Online</div>
</header>

<div class="container">
    <div class="tabs">
        <button class="tab-btn active" onclick="openTab('tab-rekap')">üìä Rekap Nilai</button>
        <button class="tab-btn" onclick="openTab('tab-input')">üìù Buat Soal</button>
        <button class="tab-btn" onclick="openTab('tab-bank')">üìö Bank Soal</button>
    </div>

    <div id="tab-rekap" class="tab-content">
        <div class="card">
            <h3 style="margin-top: 0;">üìä Hasil Ujian Siswa</h3>
            <div style="overflow-x: auto;">
                <table>
                    <thead>
                        <tr><th>Waktu</th><th>Nama</th><th>Kelas</th><th>Mapel</th><th>Skor</th><th>Aksi</th></tr>
                    </thead>
                    <tbody id="tabelNilai"><tr><td colspan="6" style="text-align:center;">Memuat data...</td></tr></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="tab-input" class="tab-content" style="display:none;">
        <div class="card">
            <h3 style="margin-top: 0;">üìù Buat Soal Baru</h3>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                <div>
                    <label>Pilih Kelompok Kelas</label>
                    <select id="pilihKelompok" onchange="updateDaftarKelas()">
                        <option value="" disabled selected>Pilih Kelas</option>
                        <option value="7">Kelas 7</option><option value="8">Kelas 8</option><option value="9">Kelas 9</option>
                    </select>
                    <div id="areaKls" class="area-kls-check">
                        <div style="grid-column: span 3; text-align: center; font-size: 0.8rem; padding: 10px;">Pilih tingkat kelas</div>
                    </div>
                </div>
                <div>
                    <label>Mata Pelajaran</label>
                    <select id="mapelSoal">
                    <option value="" disabled selected>Pilih Mata Pelajaran</option>
                    <option value="PAI">Pendidikan Agama</option>
                    <option value="PP">Pendidikan Pancasila</option>
                    <option value="B.Indo">Bahasa Indonesia</option>                     
                    <option value="Matematika">Matematika</option>
                    <option value="IPA">IPA</option>
                    <option value="IPS">IPS</option>
                    <option value="B.Inggris">Bahasa Inggris</option>
                    <option value="PJOK">PJOK</option>
                    <option value="Seni Budaya">Seni Budaya</option>
                    <option value="Informatika">Informatika</option>
                    </select>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <input type="number" id="durasiSoal" value="60" placeholder="Menit">
                        <input type="number" id="limitSoal" value="10" placeholder="Limit">
                    </div>
                </div>
            </div>
            <textarea id="tanya" placeholder="Tulis soal di sini..." style="height: 100px; margin-top: 10px;"></textarea>
            <input type="file" id="fileGambar" accept="image/*">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                <input type="text" id="opta" placeholder="Pilihan A"><input type="text" id="optb" placeholder="Pilihan B">
                <input type="text" id="optc" placeholder="Pilihan C"><input type="text" id="optd" placeholder="Pilihan D">
            </div>
            <select id="kunci">
                <option value="A">Kunci: A</option><option value="B">Kunci: B</option><option value="C">Kunci: C</option><option value="D">Kunci: D</option>
            </select>
            <button class="btn btn-success" id="btnSoal" onclick="simpanSoal()">üíæ Simpan Soal</button>
        </div>
    </div>

    <div id="tab-bank" class="tab-content" style="display:none;">
        <div class="card">
            <h3 style="margin-top: 0;">üìö Bank Soal Aktif</h3>
            <div style="overflow-x: auto;">
                <table>
                    <thead><tr><th>Mapel</th><th>Kelas</th><th>Pertanyaan</th><th>Kunci</th><th>Aksi</th></tr></thead>
                    <tbody id="tabelBankSoal"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<footer>
    <div class="footer-brand">SMPN 110 JAKARTA @ 2026</div>
    <div>Created by Endra</div>
</footer>

<div id="customModal">
    <div class="modal-content">
        <h3 id="modalTitle" style="margin-top:0; color:var(--primary);">Pemberitahuan</h3>
        <p id="modalMsg" style="color:var(--text-sub); line-height:1.5;"></p>
        <div class="modal-btns" id="modalBtns"></div>
    </div>
</div>

<script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbz2Q6LgxLl2yYXPqKUj3jSFZ38VT94ZCu-eUfcBGvNQfr_qp_kNNCM-NYL2Xb5gqy6V/exec"; 
    const databaseKelas = { "7": ["7A","7B","7C","7D","7E","7F"], "8": ["8A","8B","8C","8D","8E","8F"], "9": ["9A","9B","9C","9D","9E","9F"] };

    function showModal(msg, type = 'alert', onConfirm = null) {
        const modal = document.getElementById('customModal');
        document.getElementById('modalMsg').innerText = msg;
        const btnArea = document.getElementById('modalBtns');
        btnArea.innerHTML = "";
        modal.style.display = "block";

        if(type === 'alert') {
            const btn = document.createElement('button');
            btn.className = "btn-modal btn-primary";
            btn.innerText = "Oke";
            btn.style.background = "var(--primary)"; btn.style.color = "white";
            btn.onclick = () => modal.style.display = "none";
            btnArea.appendChild(btn);
        } else {
            const btnNo = document.createElement('button');
            btnNo.className = "btn-modal"; btnNo.innerText = "Batal";
            btnNo.style.background = "#334155"; btnNo.style.color = "white";
            btnNo.onclick = () => modal.style.display = "none";
            const btnYes = document.createElement('button');
            btnYes.className = "btn-modal"; btnYes.innerText = "Ya, Hapus";
            btnYes.style.background = "var(--danger)"; btnYes.style.color = "white";
            btnYes.onclick = () => { modal.style.display = "none"; onConfirm(); };
            btnArea.appendChild(btnNo); btnArea.appendChild(btnYes);
        }
    }

    function openTab(tabId) {
        document.querySelectorAll('.tab-content').forEach(c => c.style.display = 'none');
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(tabId).style.display = 'block';
        event.currentTarget.classList.add('active');
        if(tabId === 'tab-rekap') loadNilai();
        if(tabId === 'tab-bank') loadBankSoal();
    }

    function updateDaftarKelas() {
        const tingkat = document.getElementById('pilihKelompok').value;
        const area = document.getElementById('areaKls');
        area.innerHTML = "";
        (databaseKelas[tingkat] || []).forEach(kls => {
            const item = document.createElement('label');
            item.className = "check-item";
            item.innerHTML = `<input type="checkbox" value="${kls}" checked> ${kls}`;
            area.appendChild(item);
        });
    }

    async function loadNilai() {
        const tbody = document.getElementById('tabelNilai');
        // Ikon ‚è≥ dihapus
        tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;">Memuat data...</td></tr>';
        try {
            const res = await fetch(`${SCRIPT_URL}?target=rekap`);
            const data = await res.json();
            tbody.innerHTML = data.reverse().map(row => `
                <tr><td><small>${row[0]}</small></td><td><b>${row[1]}</b></td><td>${row[2]}</td><td>${row[3]}</td>
                <td><b style="color:var(--success)">${row[4]}</b></td>
                <td><button class="btn btn-danger" onclick="showModal('Gunakan Google Sheets untuk hapus rekap.')">üóëÔ∏è</button></td></tr>
            `).join('');
        } catch(e) { tbody.innerHTML = '<tr><td colspan="6">Gagal memuat.</td></tr>'; }
    }

    async function loadBankSoal() {
        const tbody = document.getElementById('tabelBankSoal');
        // Ikon ‚è≥ dihapus
        tbody.innerHTML = "<tr><td colspan='5' style='text-align:center'>Memuat...</td></tr>";
        try {
            const res = await fetch(`${SCRIPT_URL}?target=dbSoal`);
            const data = await res.json();
            tbody.innerHTML = data.map((row, index) => `
                <tr><td>${row.mapel}</td><td><small>${row.kelas}</small></td><td>${row.pertanyaan.substring(0,40)}...</td>
                <td><b>${row.kunci}</b></td><td><button class="btn btn-danger" onclick="confirmHapus(${index})">üóëÔ∏è Hapus</button></td></tr>
            `).join('');
        } catch(e) { tbody.innerHTML = "<tr><td colspan='5' style='text-align:center'>Data kosong.</td></tr>"; }
    }

    function confirmHapus(index) {
        showModal("Hapus soal ini dari database?", "confirm", async () => {
            await fetch(SCRIPT_URL, { method: "POST", body: JSON.stringify({ target: "hapusSoal", index: index }) });
            loadBankSoal();
        });
    }

    async function simpanSoal() {
        const kls = Array.from(document.querySelectorAll('#areaKls input:checked')).map(el => el.value).join(', ');
        if(!kls || !document.getElementById('tanya').value) return showModal("Mohon isi pertanyaan dan pilih kelas!");
        
        const btn = document.getElementById('btnSoal');
        btn.disabled = true; 
        // Ikon ‚è≥ dihapus
        btn.innerText = "Menyimpan...";
        
        let base64 = "";
        const file = document.getElementById('fileGambar').files[0];
        if(file) {
            base64 = await new Promise(r => {
                const rd = new FileReader();
                rd.onload = e => r(e.target.result);
                rd.readAsDataURL(file);
            });
        }
        
        const payload = {
            target: "tambahSoal",
            values: [kls, document.getElementById('mapelSoal').value, document.getElementById('tanya').value, 
                     document.getElementById('opta').value, document.getElementById('optb').value, 
                     document.getElementById('optc').value, document.getElementById('optd').value, 
                     document.getElementById('kunci').value, document.getElementById('durasiSoal').value, 
                     base64, document.getElementById('limitSoal').value, "AKTIF"]
        };
        
        try {
            await fetch(SCRIPT_URL, { method: "POST", body: JSON.stringify(payload) });
            showModal("‚úÖ Berhasil disimpan!");
            setTimeout(() => location.reload(), 1200);
        } catch(e) {
            showModal("‚ùå Gagal simpan.");
            btn.disabled = false; 
            btn.innerText = "üíæ Simpan Soal";
        }
    }

    window.onload = loadNilai;
</script>
</body>
</html>