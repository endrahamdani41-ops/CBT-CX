<!DOCTYPE html>
<html lang="id" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel Guru - Smart CBT</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        :root { 
            --bg: #0f172a; --card: #1e293b; --text: #f1f5f9; 
            --primary: #2563eb; --border: #334155; --success: #10b981; 
            --danger: #ef4444; --edit: #f59e0b;
        }
        
        body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); margin: 0; }
        
        .navbar { display: flex; background: var(--card); padding: 10px; border-bottom: 1px solid var(--border); justify-content: center; gap: 10px; position: sticky; top: 0; z-index: 100; }
        .nav-btn { padding: 10px 20px; border-radius: 10px; border: none; background: transparent; color: var(--text); cursor: pointer; font-weight: 600; transition: 0.3s; }
        .nav-btn.active { background: var(--primary); color: white; }
        
        .container { max-width: 1300px; margin: 30px auto; padding: 0 20px; }
        .card { background: var(--card); padding: 25px; border-radius: 15px; border: 1px solid var(--border); margin-bottom: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .section { display: none; }
        .section.active { display: block; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 0.9rem; background: rgba(0,0,0,0.2); }
        th, td { padding: 12px; border: 1px solid var(--border); vertical-align: top; }
        th { background: rgba(37, 99, 235, 0.1); color: var(--primary); font-weight: 800; text-transform: uppercase; font-size: 0.7rem; }
        
        .col-check { width: 40px; text-align: center; }
        .col-mapel { width: 150px; } 
        .col-kecil { width: 80px; text-align: center; }
        
        input, select, textarea { width: 100%; padding: 12px; border-radius: 8px; border: 1px solid var(--border); background: var(--bg); color: white; margin-bottom: 15px; box-sizing: border-box; }
        .btn-main { width: 100%; padding: 15px; border-radius: 10px; border: none; background: var(--primary); color: white; font-weight: bold; cursor: pointer; }
        .btn-action { border: none; padding: 6px 10px; border-radius: 6px; cursor: pointer; color: white; margin: 2px; }
        
        .floating-bar { 
            position: fixed; bottom: 25px; left: 50%; transform: translateX(-50%); 
            background: var(--success); color: white; padding: 15px 35px; 
            border-radius: 50px; box-shadow: 0 10px 30px rgba(16, 185, 129, 0.4); 
            display: none; cursor: pointer; font-weight: 800; z-index: 1000; transition: 0.3s; 
        }
        .floating-bar:hover { transform: translateX(-50%) translateY(-5px); }
        
        .editing-mode { border: 2px solid var(--edit) !important; background: rgba(245, 158, 11, 0.05) !important; }
        .q-text { font-weight: 600; color: var(--text); display: block; margin-bottom: 5px; }
        .opt-list { font-size: 0.8rem; color: #94a3b8; }
    </style>
</head>
<body>

<div class="navbar">
    <button class="nav-btn active" onclick="showSection('buat-soal', this)">‚úçÔ∏è Buat Soal</button>
    <button class="nav-btn" onclick="showSection('daftar-soal', this)">üìö Bank Soal</button>
    <button class="nav-btn" onclick="showSection('rekap-nilai', this)">üìä Rekap Nilai</button>
</div>

<div class="container">
    <div id="publish-bar" class="floating-bar" onclick="terbitkanUjian()">
        üöÄ Terbitkan <span id="count-soal">0</span> Soal Pilihan ke Siswa
    </div>

    <div id="buat-soal" class="section active card">
        <h2 id="form-title">Input Soal Baru</h2>
        <input type="hidden" id="old-question">
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
            <select id="soal-mapel">
					<option value="" disabled selected>Pilih Mata Pelajaran</option>
                    <option value="PAI">Pendidikan Agama</option>
                    <option value="PP">Pendidikan Pancasila</option>
                    <option value="B.Indo">Bahasa Indonesia</option>                     
                    <option value="Matematika">Matematika</option>
                    <option value="IPA">IPA</option>
                    <option value="IPS">IPS</option>
                    <option value="B.Inggris">Bahasa Inggris</option>
                    <option value="PJOK">PJOK</option>
                    <option value="Seni Budaya">Seni Budaya</option>
                    <option value="Informatika">Informatika</option>

            </select>
            <select id="soal-kelas">
                <option value="" disabled selected>Kelas</option>
                <option value="7">7</option><option value="8">8</option><option value="9">9</option>
            </select>
        </div>
        <textarea id="pertanyaan" placeholder="Tulis pertanyaan..." rows="3"></textarea>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
            <input type="text" id="opsi-a" placeholder="Opsi A">
            <input type="text" id="opsi-b" placeholder="Opsi B">
            <input type="text" id="opsi-c" placeholder="Opsi C">
            <input type="text" id="opsi-d" placeholder="Opsi D">
        </div>
        <select id="kunci-jawaban">
            <option value="" disabled selected>Kunci Jawaban</option>
            <option value="A">A</option><option value="B">B</option><option value="C">C</option><option value="D">D</option>
        </select>
        <button class="btn-main" id="btn-simpan" onclick="simpanSoal()">üíæ Simpan ke Bank Soal</button>
        <button id="btn-batal" class="btn-main" style="background:var(--border); margin-top:10px; display:none;" onclick="cancelEdit()">‚ùå Batal Edit</button>
    </div>

    <div id="daftar-soal" class="section card">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
            <h2>üìö Bank Soal (Gudang)</h2>
            <div style="display: flex; gap: 10px;">
                <button onclick="toggleSelectAll()" class="nav-btn" style="border:1px solid var(--border); font-size: 0.8rem;">‚úîÔ∏è Pilih Semua</button>
                <button onclick="muatDaftarSoal()" class="nav-btn" style="border:1px solid var(--border)">üîÑ Refresh</button>
            </div>
        </div>
        <div style="overflow-x:auto">
            <table>
                <thead>
                    <tr>
                        <th class="col-check">Pilih</th>
                        <th class="col-mapel">Mapel</th>
                        <th class="col-kecil">Kelas</th>
                        <th>Pertanyaan & Opsi</th>
                        <th class="col-kecil">Kunci</th>
                        <th class="col-kecil">Aksi</th>
                    </tr>
                </thead>
                <tbody id="body-soal"></tbody>
            </table>
        </div>
    </div>

    <div id="rekap-nilai" class="section card">
        <h2>üìä Hasil Ujian Siswa</h2>
        <div style="overflow-x:auto">
            <table>
                <thead>
                    <tr>
                        <th>Waktu</th><th>NIS</th><th>Nama</th><th>Kelas</th><th>Mapel</th><th>Skor</th><th>Aksi</th>
                    </tr>
                </thead>
                <tbody id="body-nilai"></tbody>
            </table>
        </div>
    </div>
</div>

<script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwIrgRGQadp68Qz1wtVM9xbUNAMkov2T-_eSG44MjM10lkouGvHcRt71Hf3Z_aOjRim/exec";
    const swalDark = Swal.mixin({ background: '#1e293b', color: '#f1f5f9', confirmButtonColor: '#2563eb', cancelButtonColor: '#334155' });
    let daftarSoalLokal = [];

    // Tampilkan Section
    function showSection(id, btn) {
        document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        btn.classList.add('active');
        if(id === 'daftar-soal') muatDaftarSoal();
        if(id === 'rekap-nilai') muatRekapNilai();
        document.getElementById('publish-bar').style.display = 'none';
    }

    // CRUD: Simpan & Update
    async function simpanSoal() {
        const data = {
            target: "simpanSoal",
            old_pertanyaan: document.getElementById('old-question').value,
            mapel: document.getElementById('soal-mapel').value,
            kelas: document.getElementById('soal-kelas').value,
            pertanyaan: document.getElementById('pertanyaan').value,
            a: document.getElementById('opsi-a').value,
            b: document.getElementById('opsi-b').value,
            c: document.getElementById('opsi-c').value,
            d: document.getElementById('opsi-d').value,
            kunci: document.getElementById('kunci-jawaban').value
        };

        if(!data.pertanyaan || !data.mapel || !data.kunci) return swalDark.fire('Lengkapi form!', '', 'warning');
        
        swalDark.fire({ title: 'Menyimpan...', didOpen: () => Swal.showLoading() });
        try {
            await fetch(SCRIPT_URL, { method: "POST", mode: "no-cors", body: JSON.stringify(data) });
            swalDark.fire('Berhasil!', 'Soal tersimpan di Bank Soal.', 'success').then(() => location.reload());
        } catch (e) { swalDark.fire('Gagal!', 'Cek koneksi internet.', 'error'); }
    }

    // Load Data Bank Soal
    async function muatDaftarSoal() {
        const body = document.getElementById('body-soal');
        body.innerHTML = "<tr><td colspan='6' style='text-align:center'>Memuat Gudang Soal...</td></tr>";
        try {
            const res = await fetch(SCRIPT_URL + "?target=listSemuaSoal");
            let data = await res.json();
            // Urutkan berdasarkan kelas
            data.sort((a, b) => a.kelas - b.kelas);
            daftarSoalLokal = data;
            renderTabelSoal();
        } catch (e) { body.innerHTML = "Gagal memuat data."; }
    }

    function renderTabelSoal() {
        const body = document.getElementById('body-soal');
        body.innerHTML = daftarSoalLokal.map((s, i) => `
            <tr>
                <td class="col-check"><input type="checkbox" class="soal-checkbox" value="${i}" onchange="updateSelection()"></td>
                <td>${s.mapel}</td>
                <td class="text-center">${s.kelas}</td>
                <td>
                    <span class="q-text">${s.soal}</span>
                    <div class="opt-list">A: ${s.a} | B: ${s.b} | C: ${s.c} | D: ${s.d}</div>
                </td>
                <td class="text-center"><b style="color:var(--success)">${s.kunci}</b></td>
                <td class="text-center">
                    <button class="btn-action" style="background:var(--edit)" onclick="prepareEdit(${i})">‚úèÔ∏è</button>
                    <button class="btn-action" style="background:var(--danger)" onclick="hapusSoal('${s.soal}')">üóëÔ∏è</button>
                </td>
            </tr>
        `).join('');
    }

    // Fungsi Terbitkan (Ke DB_SOAL)
    async function terbitkanUjian() {
        const checked = document.querySelectorAll('.soal-checkbox:checked');
        const soalPilihan = Array.from(checked).map(cb => daftarSoalLokal[cb.value]);

        const konfirmasi = await swalDark.fire({
            title: 'Terbitkan Ujian?',
            text: `Kirim ${soalPilihan.length} soal ke etalase ujian siswa?`,
            icon: 'question',
            showCancelButton: true, confirmButtonText: 'Ya, Terbitkan!'
        });

        if (konfirmasi.isConfirmed) {
            swalDark.fire({ title: 'Menerbitkan...', didOpen: () => Swal.showLoading() });
            try {
                await fetch(SCRIPT_URL, { method: "POST", mode: "no-cors", body: JSON.stringify({ target: "terbitkanUjian", soal: soalPilihan }) });
                swalDark.fire('Berhasil!', 'Soal sudah aktif di layar siswa.', 'success');
                document.querySelectorAll('.soal-checkbox').forEach(c => c.checked = false);
                updateSelection();
            } catch (e) { swalDark.fire('Gagal!', '', 'error'); }
        }
    }

    // Helper: Edit & Delete (Sama seperti kode sebelumnya...)
    function prepareEdit(idx) {
        const s = daftarSoalLokal[idx];
        document.getElementById('old-question').value = s.soal;
        document.getElementById('soal-mapel').value = s.mapel;
        document.getElementById('soal-kelas').value = s.kelas;
        document.getElementById('pertanyaan').value = s.soal;
        document.getElementById('opsi-a').value = s.a;
        document.getElementById('opsi-b').value = s.b;
        document.getElementById('opsi-c').value = s.c;
        document.getElementById('opsi-d').value = s.d;
        document.getElementById('kunci-jawaban').value = s.kunci;
        document.getElementById('form-title').innerText = "‚úèÔ∏è Mode Edit Soal";
        document.getElementById('btn-simpan').innerText = "üÜô Update Soal";
        document.getElementById('btn-batal').style.display = "block";
        document.getElementById('buat-soal').classList.add('editing-mode');
        showSection('buat-soal', document.querySelector('.nav-btn'));
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function cancelEdit() { location.reload(); }

    function updateSelection() {
        const n = document.querySelectorAll('.soal-checkbox:checked').length;
        const bar = document.getElementById('publish-bar');
        document.getElementById('count-soal').innerText = n;
        bar.style.display = n > 0 ? 'block' : 'none';
    }

    function toggleSelectAll() {
        const cbs = document.querySelectorAll('.soal-checkbox');
        const any = Array.from(cbs).some(c => !c.checked);
        cbs.forEach(c => c.checked = any);
        updateSelection();
    }
</script>
</body>
</html>