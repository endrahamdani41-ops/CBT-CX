<!DOCTYPE html>
<html lang="id" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart CBT - Dashboard Guru</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        :root { --bg-body: #0f172a; --bg-card: #1e293b; --text-main: #f1f5f9; --text-sub: #94a3b8; --border: #334155; --primary: #2563eb; --success: #10b981; --danger: #ef4444; }
        body { font-family: 'Inter', sans-serif; background: var(--bg-body); color: var(--text-main); margin: 0; padding: 20px; }
        .container { max-width: 1100px; margin: auto; }
        .card { background: var(--bg-card); padding: 25px; border-radius: 20px; border: 1px solid var(--border); margin-bottom: 25px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); text-align: center; }
        h3 { margin-top: 0; font-weight: 800; color: var(--primary); text-transform: uppercase; letter-spacing: 1px; }
        
        .tabs { display: flex; gap: 10px; margin-bottom: 25px; background: rgba(255,255,255,0.05); padding: 8px; border-radius: 15px; }
        .tab-btn { flex: 1; padding: 12px; border: none; background: transparent; color: var(--text-sub); cursor: pointer; border-radius: 10px; font-weight: 600; transition: 0.3s; }
        .tab-btn.active { background: var(--primary); color: white; box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3); }

        .form-box { max-width: 700px; margin: auto; }
        select, input, textarea { width: 100%; padding: 12px; margin: 8px 0; border-radius: 10px; border: 1px solid var(--border); background: #0f172a; color: white; text-align: center; font-family: inherit; box-sizing: border-box; outline: none; }
        textarea { text-align: left; height: 100px; padding: 15px; }

        .kelas-container { background: rgba(0,0,0,0.2); padding: 20px; border-radius: 15px; border: 2px dashed var(--border); margin: 15px 0; display: none; }
        
        /* Gaya Judul Ceklis yang Bisa Di-klik */
        .group-title { 
            display: inline-block; font-weight: 800; color: var(--primary); 
            margin-bottom: 15px; font-size: 0.9rem; text-align: center; 
            cursor: pointer; padding: 5px 15px; border-radius: 20px;
            transition: 0.2s; border: 1px solid transparent;
        }
        .group-title:hover { background: rgba(37, 99, 235, 0.1); border-color: var(--primary); }
        .group-title:active { transform: scale(0.95); }

        .checkbox-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; justify-items: center; align-items: center; }
        .checkbox-item { display: flex; align-items: center; justify-content: center; gap: 10px; font-size: 1rem; cursor: pointer; background: rgba(255,255,255,0.05); padding: 8px 15px; border-radius: 8px; width: 80px; transition: 0.2s; }
        .checkbox-item:hover { background: rgba(37, 99, 235, 0.2); }
        .checkbox-item input { width: 20px !important; height: 20px !important; margin: 0 !important; cursor: pointer; accent-color: var(--primary); }

        .table-container { overflow-x: auto; margin-top: 20px; border-radius: 15px; border: 1px solid var(--border); }
        table { width: 100%; border-collapse: collapse; text-align: center; background: rgba(0,0,0,0.1); }
        th { background: var(--primary); color: white; padding: 15px; font-size: 0.75rem; text-transform: uppercase; }
        td { padding: 14px; border-bottom: 1px solid var(--border); font-size: 0.85rem; }
        .btn-table { padding: 8px 15px; border: none; border-radius: 8px; cursor: pointer; color: white; font-weight: bold; transition: 0.2s; }

        .opsi-list { display: block; font-size: 0.8rem; color: var(--text-sub); margin-top: 10px; text-align: left; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 8px; }
        .opsi-item { display: block; margin-bottom: 3px; padding: 2px 5px; border-radius: 4px; }
        .kunci-true { color: var(--success); font-weight: 800; background: rgba(16, 185, 129, 0.1); }
    </style>
</head>
<body>

<div class="container">
    <div class="tabs">
        <button id="btn-rekap" class="tab-btn active" onclick="openTab('rekap')">üìä Rekap Nilai</button>
        <button id="btn-input" class="tab-btn" onclick="openTab('input')">üìù Buat Soal</button>
        <button id="btn-bank" class="tab-btn" onclick="openTab('bank')">üìö Bank Soal</button>
    </div>

    <div id="rekap" class="tab-content">
        <div class="card">
            <h3>üìä Hasil Ujian Siswa</h3>
            <div class="table-container">
                <table>
                    <thead>
                        <tr><th>No</th><th>NIS</th><th>Nama</th><th>Kelas</th><th>Mapel</th><th>Skor</th></tr>
                    </thead>
                    <tbody id="tabelNilai"><tr><td colspan="6">‚è≥ Memuat data...</td></tr></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="input" class="tab-content" style="display:none;">
        <div class="card">
            <h3>üìù Buat Soal Baru</h3>
            <div class="form-box">
                <select id="mapel">
                   <option value="" disabled selected>Pilih Mapel</option>
                    <option value="PAI">Pendidikan Agama</option>
                    <option value="PP">Pendidikan Pancasila</option>
                    <option value="B.Indo">Bahasa Indonesia</option>                     
                    <option value="Matematika">Matematika</option>
                    <option value="IPA">IPA</option>
                    <option value="IPS">IPS</option>
                    <option value="B.Inggris">Bahasa Inggris</option>
                    <option value="PJOK">PJOK</option>
                    <option value="Seni Budaya">Seni Budaya</option>
                    <option value="Informatika">Informatika</option>
                </select>

                <select id="tingkatKelas" onchange="filterCheckboxKelas()">
                    <option value="" disabled selected>Pilih Tingkat Kelas</option>
                    <option value="7">Kelas 7</option>
                    <option value="8">Kelas 8</option>
                    <option value="9">Kelas 9</option>
                </select>

                <div id="boxKelas7" class="kelas-container">
                    <label class="group-title" onclick="toggleCeklis('boxKelas7')">üëâ CEKLIS SEMUA KELAS 7</label>
                    <div class="checkbox-grid">
                        <label class="checkbox-item"><input type="checkbox" name="chkKelas" value="7A"> 7A</label>
                        <label class="checkbox-item"><input type="checkbox" name="chkKelas" value="7B"> 7B</label>
                        <label class="checkbox-item"><input type="checkbox" name="chkKelas" value="7C"> 7C</label>
                        <label class="checkbox-item"><input type="checkbox" name="chkKelas" value="7D"> 7D</label>
                        <label class="checkbox-item"><input type="checkbox" name="chkKelas" value="7E"> 7E</label>
                        <label class="checkbox-item"><input type="checkbox" name="chkKelas" value="7F"> 7F</label>
                    </div>
                </div>

                <div id="boxKelas8" class="kelas-container">
                    <label class="group-title" onclick="toggleCeklis('boxKelas8')">üëâ CEKLIS SEMUA KELAS 8</label>
                    <div class="checkbox-grid">
                        <label class="checkbox-item"><input type="checkbox" name="chkKelas" value="8A"> 8A</label>
                        <label class="checkbox-item"><input type="checkbox" name="chkKelas" value="8B"> 8B</label>
                        <label class="checkbox-item"><input type="checkbox" name="chkKelas" value="8C"> 8C</label>
                        <label class="checkbox-item"><input type="checkbox" name="chkKelas" value="8D"> 8D</label>
                        <label class="checkbox-item"><input type="checkbox" name="chkKelas" value="8E"> 8E</label>
                        <label class="checkbox-item"><input type="checkbox" name="chkKelas" value="8F"> 8F</label>
                    </div>
                </div>

                <div id="boxKelas9" class="kelas-container">
                    <label class="group-title" onclick="toggleCeklis('boxKelas9')">üëâ CEKLIS SEMUA KELAS 9</label>
                    <div class="checkbox-grid">
                        <label class="checkbox-item"><input type="checkbox" name="chkKelas" value="9A"> 9A</label>
                        <label class="checkbox-item"><input type="checkbox" name="chkKelas" value="9B"> 9B</label>
                        <label class="checkbox-item"><input type="checkbox" name="chkKelas" value="9C"> 9C</label>
                        <label class="checkbox-item"><input type="checkbox" name="chkKelas" value="9D"> 9D</label>
                        <label class="checkbox-item"><input type="checkbox" name="chkKelas" value="9E"> 9E</label>
                        <label class="checkbox-item"><input type="checkbox" name="chkKelas" value="9F"> 9F</label>
                    </div>
                </div>

                <textarea id="tanya" placeholder="Tuliskan Pertanyaan..."></textarea>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                    <input type="text" id="opta" placeholder="Pilihan A">
                    <input type="text" id="optb" placeholder="Pilihan B">
                    <input type="text" id="optc" placeholder="Pilihan C">
                    <input type="text" id="optd" placeholder="Pilihan D">
                </div>
                <select id="kunci">
                    <option value="" disabled selected>Pilih Kunci Jawaban</option>
                    <option value="A">A</option><option value="B">B</option><option value="C">C</option><option value="D">D</option>
                </select>
                <button class="btn-table" style="background:var(--success); width:100%; padding:15px; margin-top:10px;" onclick="simpanSoal()">üíæ SIMPAN SOAL</button>
            </div>
        </div>
    </div>

    <div id="bank" class="tab-content" style="display:none;">
        <div class="card">
            <h3>üìö Bank Soal</h3>
            <div class="table-container">
                <table>
                    <thead>
                        <tr><th>Mapel/Kelas</th><th>Pertanyaan & Opsi</th><th>Status</th><th>Aksi</th></tr>
                    </thead>
                    <tbody id="tabelBank"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbz3eO59ouj3-okVJfW75i_p2974i-QzGlk_xj8DXl5k_r-3oD3xkioXbATAaUVS-vB3/exec"; 

    // FUNGSI BARU: TOGGLE CEKLIS SEMUA KELAS
    function toggleCeklis(boxId) {
        const container = document.getElementById(boxId);
        const checkboxes = container.querySelectorAll('input[name="chkKelas"]');
        
        // Cek apakah ada yang belum diceklis
        const isAllChecked = Array.from(checkboxes).every(cb => cb.checked);
        
        // Jika semua sudah diceklis, maka kosongkan. Jika belum, ceklis semua.
        checkboxes.forEach(cb => cb.checked = !isAllChecked);
    }

    function openTab(tabId) {
        document.querySelectorAll('.tab-content').forEach(t => t.style.display = 'none');
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(tabId).style.display = 'block';
        if (event) event.currentTarget.classList.add('active');
        if(tabId === 'rekap') loadNilai();
        if(tabId === 'bank') loadBank();
    }

    function filterCheckboxKelas() {
        const t = document.getElementById('tingkatKelas').value;
        document.querySelectorAll('.kelas-container').forEach(el => el.style.display = 'none');
        document.getElementById('boxKelas' + t).style.display = 'block';
    }

    async function loadNilai() {
        const tbody = document.getElementById('tabelNilai');
        try {
            const res = await fetch(SCRIPT_URL + "?target=dbNilai");
            const data = await res.json();
            tbody.innerHTML = data.reverse().map((r, i) => `
                <tr>
                    <td>${i+1}</td>
                    <td>${r.nis}</td>
                    <td style="text-align:left">${r.nama}</td>
                    <td>${r.kelas}</td>
                    <td>${r.mapel}</td>
                    <td><b style="color:var(--primary)">${r.skor}</b></td>
                </tr>`).join('');
        } catch (e) { tbody.innerHTML = "<tr><td colspan='6'>Gagal memuat data.</td></tr>"; }
    }

    async function loadBank() {
        const tbody = document.getElementById('tabelBank');
        tbody.innerHTML = "<tr><td colspan='4'>‚è≥ Memuat...</td></tr>";
        try {
            const res = await fetch(SCRIPT_URL + "?target=dbSoal");
            const data = await res.json();
            tbody.innerHTML = data.map((r, i) => {
                const isAktif = (r.status || 'AKTIF').toUpperCase() === 'AKTIF';
                return `
                <tr>
                    <td><b>${r.mapel}</b><br><small>${r.kelas}</small></td>
                    <td style="text-align:left">
                        <div style="font-weight:800; margin-bottom:5px;">${r.pertanyaan}</div>
                        <div class="opsi-list">
                            <span class="opsi-item ${r.kunci === 'A' ? 'kunci-true' : ''}">A. ${r.a}</span>
                            <span class="opsi-item ${r.kunci === 'B' ? 'kunci-true' : ''}">B. ${r.b}</span>
                            <span class="opsi-item ${r.kunci === 'C' ? 'kunci-true' : ''}">C. ${r.c}</span>
                            <span class="opsi-item ${r.kunci === 'D' ? 'kunci-true' : ''}">D. ${r.d}</span>
                        </div>
                    </td>
                    <td><button class="btn-table" style="background:${isAktif?'var(--success)':'var(--danger)'}" onclick="toggleStatus(${i},'${r.status||'AKTIF'}')">${r.status||'AKTIF'}</button></td>
                    <td><button class="btn-table" style="background:var(--danger)" onclick="hapusSoal(${i})">üóëÔ∏è</button></td>
                </tr>`;
            }).join('');
        } catch (e) { tbody.innerHTML = "<tr><td colspan='4'>Gagal memuat.</td></tr>"; }
    }

    async function simpanSoal() {
        const checked = document.querySelectorAll('input[name="chkKelas"]:checked');
        if (checked.length === 0) return alert("Pilih minimal satu kelas!");
        const daftarKelas = Array.from(checked).map(c => c.value).join(', ');
        const p = {
            action: "tambahSoal",
            mapel: document.getElementById('mapel').value,
            kelas: daftarKelas,
            pertanyaan: document.getElementById('tanya').value,
            a: document.getElementById('opta').value, b: document.getElementById('optb').value,
            c: document.getElementById('optc').value, d: document.getElementById('optd').value,
            kunci: document.getElementById('kunci').value
        };
        if(!p.mapel || !p.pertanyaan || !p.kunci) return alert("Lengkapi semua data!");
        
        event.target.innerText = "‚è≥ Menyimpan...";
        await fetch(SCRIPT_URL, { method: "POST", mode: "no-cors", body: JSON.stringify(p) });
        alert("Berhasil disimpan!");
        location.reload();
    }

    async function toggleStatus(idx, current) {
        const next = current === 'AKTIF' ? 'NONAKTIF' : 'AKTIF';
        await fetch(SCRIPT_URL, { method: "POST", mode: "no-cors", body: JSON.stringify({action:"updateStatus", index:idx, status:next}) });
        setTimeout(loadBank, 800);
    }

    async function hapusSoal(idx) {
        if(!confirm("Hapus soal?")) return;
        await fetch(SCRIPT_URL, { method: "POST", mode: "no-cors", body: JSON.stringify({action:"hapusSoal", index:idx}) });
        setTimeout(loadBank, 800);
    }

    window.onload = loadNilai;
</script>
</body>
</html>