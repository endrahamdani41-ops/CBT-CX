<!DOCTYPE html>
<html lang="id" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart CBT - Dashboard Guru</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        :root { --bg-body: #0f172a; --bg-card: #1e293b; --text-main: #f1f5f9; --text-sub: #94a3b8; --border: #334155; --primary: #2563eb; --success: #10b981; --danger: #ef4444; }
        body { font-family: 'Inter', sans-serif; background: var(--bg-body); color: var(--text-main); margin: 0; padding: 20px; }
        .container { max-width: 1100px; margin: auto; }
        .card { background: var(--bg-card); padding: 25px; border-radius: 20px; border: 1px solid var(--border); margin-bottom: 25px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); text-align: center; }
        h3 { margin-top: 0; font-weight: 800; color: var(--primary); text-transform: uppercase; letter-spacing: 1px; }
        
        /* TABS */
        .tabs { display: flex; gap: 10px; margin-bottom: 25px; background: rgba(255,255,255,0.05); padding: 8px; border-radius: 15px; }
        .tab-btn { flex: 1; padding: 12px; border: none; background: transparent; color: var(--text-sub); cursor: pointer; border-radius: 10px; font-weight: 600; transition: 0.3s; }
        .tab-btn.active { background: var(--primary); color: white; box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3); }

        /* TABLE */
        .table-container { overflow-x: auto; margin-top: 20px; border-radius: 15px; border: 1px solid var(--border); }
        table { width: 100%; border-collapse: collapse; text-align: center; background: rgba(0,0,0,0.1); }
        th { background: var(--primary); color: white; padding: 15px; font-size: 0.75rem; text-transform: uppercase; }
        td { padding: 14px; border-bottom: 1px solid var(--border); font-size: 0.85rem; vertical-align: middle; }
        tr:hover { background: rgba(255,255,255,0.03); }

        /* BUTTONS */
        .btn { padding: 8px 15px; border: none; border-radius: 8px; cursor: pointer; font-weight: 700; transition: 0.2s; color: white; display: inline-flex; align-items: center; justify-content: center; }
        .btn-status { width: 95px; font-size: 0.65rem; text-transform: uppercase; }
        .btn-danger { background: var(--danger); }
        .btn-success { background: var(--success); }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; }

        /* FORM */
        .form-box { max-width: 650px; margin: auto; }
        input, select, textarea { width: 100%; padding: 12px; margin: 8px 0; border-radius: 10px; border: 1px solid var(--border); background: #0f172a; color: white; text-align: center; font-family: inherit; box-sizing: border-box; outline: none; }
        input:focus { border-color: var(--primary); }
    </style>
</head>
<body>

<div class="container">
    <div class="tabs">
        <button class="tab-btn active" onclick="openTab('rekap')">üìä Rekap Nilai</button>
        <button class="tab-btn" onclick="openTab('input')">üìù Buat Soal</button>
        <button class="tab-btn" onclick="openTab('bank')">üìö Bank Soal</button>
    </div>

    <div id="rekap" class="tab-content">
        <div class="card">
            <h3>üìä Hasil Ujian Siswa</h3>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>No</th>
                            <th>NIS</th>
                            <th>Nama Siswa</th>
                            <th>Kelas</th>
                            <th>Mapel</th>
                            <th>Skor</th>
                        </tr>
                    </thead>
                    <tbody id="tabelNilai">
                        <tr><td colspan="6">‚è≥ Memuat data siswa...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="input" class="tab-content" style="display:none;">
        <div class="card">
            <h3>üìù Input Soal Baru</h3>
            <div class="form-box">
                <input type="text" id="mapel" placeholder="Mata Pelajaran (Contoh: IPA)">
                <input type="text" id="kelas" placeholder="Target Kelas (Contoh: 8A, 8B)">
                <textarea id="tanya" placeholder="Tulis Pertanyaan Di Sini..." style="height: 100px; text-align: left;"></textarea>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                    <input type="text" id="opta" placeholder="Opsi A">
                    <input type="text" id="optb" placeholder="Opsi B">
                    <input type="text" id="optc" placeholder="Opsi C">
                    <input type="text" id="optd" placeholder="Opsi D">
                </div>
                <select id="kunci">
                    <option value="" disabled selected>Pilih Kunci Jawaban</option>
                    <option value="A">A</option><option value="B">B</option>
                    <option value="C">C</option><option value="D">D</option>
                </select>
                <button class="btn btn-success" style="width: 100%; padding: 15px; margin-top: 10px;" onclick="simpanSoal()">
                    üíæ Simpan Soal
                </button>
            </div>
        </div>
    </div>

    <div id="bank" class="tab-content" style="display:none;">
        <div class="card">
            <h3>üìö Bank Soal</h3>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Mapel/Kelas</th>
                            <th>Pertanyaan & Opsi</th>
                            <th>Status</th>
                            <th>Aksi</th>
                        </tr>
                    </thead>
                    <tbody id="tabelBank">
                        <tr><td colspan="4">‚è≥ Memuat bank soal...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
    // GANTI URL DI BAWAH INI DENGAN URL WEB APP ANDA DARI GOOGLE APPS SCRIPT
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbw6dnRL3lyVyPRrpXP6B4pENE9tVIvmd2hatRJytSQRhcI2VLnrUjVSmz8OEU3qbfqm/exec"; 

    function openTab(id) {
        document.querySelectorAll('.tab-content').forEach(t => t.style.display = 'none');
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(id).style.display = 'block';
        event.currentTarget.classList.add('active');
        if(id === 'rekap') loadNilai();
        if(id === 'bank') loadBank();
    }

    // --- LOAD REKAP NILAI (OTOMATIS) ---
    async function loadNilai() {
        const tbody = document.getElementById('tabelNilai');
        try {
            const res = await fetch(`${SCRIPT_URL}?target=dbNilai`);
            const data = await res.json();
            tbody.innerHTML = data.reverse().map((r, i) => `
                <tr>
                    <td>${i + 1}</td>
                    <td style="color:var(--success); font-weight:bold;">${r.nis || '-'}</td>
                    <td style="text-align:left;">${r.nama}</td>
                    <td>${r.kelas}</td>
                    <td>${r.mapel}</td>
                    <td><b style="color:var(--primary); font-size:1.1rem;">${r.skor}</b></td>
                </tr>
            `).join('');
        } catch (e) {
            tbody.innerHTML = "<tr><td colspan='6'>Gagal memuat data rekap.</td></tr>";
        }
    }

    // --- LOAD BANK SOAL & TOGGLE ---
    async function loadBank() {
        const tbody = document.getElementById('tabelBank');
        try {
            const res = await fetch(`${SCRIPT_URL}?target=dbSoal`);
            const data = await res.json();
            tbody.innerHTML = data.map((r, i) => {
                const statusStr = (r.status || 'AKTIF').toUpperCase();
                const isAktif = statusStr === 'AKTIF';
                return `
                <tr>
                    <td><b>${r.mapel}</b><br><small>${r.kelas}</small></td>
                    <td style="text-align:left;">
                        <b>${r.pertanyaan}</b><br>
                        <small style="color:var(--text-sub)">A: ${r.a} | B: ${r.b} | C: ${r.c} | D: ${r.d}</small>
                    </td>
                    <td>
                        <button class="btn btn-status" style="background:${isAktif ? 'var(--success)' : 'var(--danger)'}" 
                        onclick="toggleStatus(${i}, '${statusStr}')">
                            ${statusStr}
                        </button>
                    </td>
                    <td>
                        <button class="btn btn-danger" style="padding:5px 10px;" onclick="hapusSoal(${i})">üóëÔ∏è</button>
                    </td>
                </tr>`;
            }).join('');
        } catch (e) {
            tbody.innerHTML = "<tr><td colspan='4'>Gagal memuat bank soal.</td></tr>";
        }
    }

    async function toggleStatus(idx, current) {
        const next = (current === 'AKTIF') ? 'NONAKTIF' : 'AKTIF';
        const btn = event.target;
        btn.innerText = "‚è≥...";
        btn.disabled = true;

        try {
            await fetch(SCRIPT_URL, {
                method: "POST",
                mode: "no-cors",
                body: JSON.stringify({ action: "updateStatus", index: idx, status: next })
            });
            // Beri jeda sebentar agar Google Sheet selesai proses
            setTimeout(loadBank, 800);
        } catch (e) {
            alert("Terjadi kesalahan.");
            loadBank();
        }
    }

    async function hapusSoal(idx) {
        if(!confirm("Hapus soal ini secara permanen?")) return;
        await fetch(SCRIPT_URL, { 
            method: "POST", 
            mode: "no-cors",
            body: JSON.stringify({ action: "hapusSoal", index: idx }) 
        });
        setTimeout(loadBank, 800);
    }

    async function simpanSoal() {
        const btn = event.target;
        const p = {
            action: "tambahSoal",
            mapel: document.getElementById('mapel').value,
            kelas: document.getElementById('kelas').value,
            pertanyaan: document.getElementById('tanya').value,
            a: document.getElementById('opta').value,
            b: document.getElementById('optb').value,
            c: document.getElementById('optc').value,
            d: document.getElementById('optd').value,
            kunci: document.getElementById('kunci').value
        };
        if(!p.mapel || !p.pertanyaan) return alert("Lengkapi data!");
        btn.innerText = "‚è≥ Menyimpan..."; btn.disabled = true;
        
        await fetch(SCRIPT_URL, { method: "POST", mode: "no-cors", body: JSON.stringify(p) });
        alert("Soal berhasil ditambah!");
        location.reload();
    }

    window.onload = loadNilai;
</script>
</body>
</html>