<!DOCTYPE html>
<html lang="id" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Siswa - Smart CBT</title>
    <style>
        :root { --bg-body: #0f172a; --bg-card: #1e293b; --text-main: #f1f5f9; --text-sub: #94a3b8; --primary: #2563eb; --success: #10b981; --danger: #ef4444; --border: #334155; }
        body { font-family: 'Inter', sans-serif; background: var(--bg-body); color: var(--text-main); margin: 0; min-height: 100vh; display: flex; flex-direction: column; }
        header { background: var(--bg-card); padding: 15px 30px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 100; }
        .container { max-width: 800px; margin: 30px auto; padding: 0 20px; flex: 1; width: 100%; box-sizing: border-box; }
        .card { background: var(--bg-card); padding: 25px; border-radius: 20px; border: 1px solid var(--border); box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        .btn { padding: 12px 24px; border: none; border-radius: 12px; cursor: pointer; font-weight: 700; transition: 0.3s; width: 100%; }
        .btn-primary { background: var(--primary); color: white; }
        input, select { width: 100%; padding: 12px; margin: 10px 0; border-radius: 10px; border: 1px solid var(--border); background: var(--bg-body); color: var(--text-main); }
        .soal-img { max-width: 100%; border-radius: 12px; margin: 15px 0; border: 1px solid var(--border); }
        .opsi-container { display: grid; gap: 10px; margin-top: 20px; }
        .opsi-btn { padding: 15px; border: 1px solid var(--border); border-radius: 12px; background: rgba(255,255,255,0.05); cursor: pointer; text-align: left; transition: 0.2s; }
        .opsi-btn:hover { background: rgba(37, 99, 235, 0.1); border-color: var(--primary); }
        .opsi-btn.selected { background: var(--primary); color: white; border-color: var(--primary); }
    </style>
</head>
<body>

<header>
    <div id="infoSiswa"><b>SMART CBT</b></div>
    <div id="timer" style="font-weight: 800; color: var(--danger);">00:00</div>
</header>

<div class="container" id="mainArea">
    <div class="card" id="loginArea">
        <h2 style="text-align:center; color:var(--primary);">Login Siswa</h2>
        <input type="text" id="nis" placeholder="Masukkan NIS">
        <button class="btn btn-primary" onclick="login()">MASUK UJIAN</button>
    </div>

    <div id="ujianArea" style="display: none;">
        <div class="card">
            <div id="kontenSoal">
                <div id="noSoal" style="font-size: 0.8rem; color: var(--text-sub); margin-bottom: 10px;">Soal 1</div>
                <div id="teksSoal" style="font-size: 1.1rem; line-height: 1.6;">Memuat soal...</div>
                <div id="gambarSoal"></div>
                <div class="opsi-container" id="opsiArea"></div>
            </div>
            <div style="display: flex; gap: 10px; margin-top: 30px;">
                <button class="btn" style="background:var(--border);" onclick="navigasi(-1)">KEMBALI</button>
                <button class="btn btn-primary" id="btnNext" onclick="navigasi(1)">LANJUT</button>
            </div>
        </div>
    </div>

    <div id="hasilArea" style="display: none; text-align: center;">
        <div class="card">
            <h1 style="color:var(--success);">Ujian Selesai!</h1>
            <p>Terima kasih telah mengerjakan ujian dengan jujur.</p>
            <div style="font-size: 4rem; font-weight: 900; margin: 20px 0;" id="skorDisplay">0</div>
            <p id="statusKirim">Data sedang dikirim...</p>
        </div>
    </div>
</div>

<script>
    // URL SCRIPT_URL HARUS SAMA DENGAN GURU.HTML
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbz2Q6LgxLl2yYXPqKUj3jSFZ38VT94ZCu-eUfcBGvNQfr_qp_kNNCM-NYL2Xb5gqy6V/exec"; 

    let dataSiswa = null;
    let daftarSoal = [];
    let soalAktif = 0;
    let jawabanSiswa = {};
    let cheatCount = 0;
    let timerInterval;

    // DETEKSI KECURANGAN (PINDAH TAB)
    window.onblur = () => {
        if(dataSiswa) {
            cheatCount++;
            alert("Peringatan! Jangan meninggalkan halaman ujian.");
        }
    };

    async function login() {
        const nisInput = document.getElementById('nis').value;
        if(!nisInput) return alert("Isi NIS!");
        
        try {
            const res = await fetch(`${SCRIPT_URL}?target=dbSiswa`);
            const siswa = await res.json();
            dataSiswa = siswa.find(s => s.nis == nisInput);
            
            if(dataSiswa) {
                document.getElementById('loginArea').style.display = 'none';
                loadSoal();
            } else { alert("NIS tidak terdaftar!"); }
        } catch(e) { alert("Gagal koneksi ke server."); }
    }

    async function loadSoal() {
        try {
            const res = await fetch(`${SCRIPT_URL}?target=dbSoal`);
            const semuaSoal = await res.json();
            // Filter soal sesuai kelas siswa
            daftarSoal = semuaSoal.filter(s => s.kelas.includes(dataSiswa.kelas) && s.status === "AKTIF");
            
            if(daftarSoal.length > 0) {
                document.getElementById('ujianArea').style.display = 'block';
                tampilkanSoal();
                startTimer(daftarSoal[0].durasi);
            } else { alert("Tidak ada ujian aktif untuk kelas Anda."); }
        } catch(e) { alert("Gagal memuat soal."); }
    }

    function tampilkanSoal() {
        const s = daftarSoal[soalAktif];
        document.getElementById('noSoal').innerText = `SOAL ${soalAktif + 1} DARI ${daftarSoal.length}`;
        document.getElementById('teksSoal').innerText = s.pertanyaan;
        
        // Render Gambar jika ada
        const boxGambar = document.getElementById('gambarSoal');
        boxGambar.innerHTML = s.gambar ? `<img src="${s.gambar}" class="soal-img">` : "";

        const areaOpsi = document.getElementById('opsiArea');
        areaOpsi.innerHTML = "";
        ['opta', 'optb', 'optc', 'optd'].forEach((key, idx) => {
            const label = String.fromCharCode(65 + idx); // A, B, C, D
            const btn = document.createElement('div');
            btn.className = `opsi-btn ${jawabanSiswa[soalAktif] === label ? 'selected' : ''}`;
            btn.innerHTML = `<b>${label}.</b> ${s[key]}`;
            btn.onclick = () => pilihJawaban(label);
            areaOpsi.appendChild(btn);
        });

        document.getElementById('btnNext').innerText = soalAktif === daftarSoal.length - 1 ? "SELESAI" : "LANJUT";
    }

    function pilihJawaban(label) {
        jawabanSiswa[soalAktif] = label;
        tampilkanSoal();
    }

    function navigasi(arah) {
        if(arah === 1 && soalAktif === daftarSoal.length - 1) return selesaiUjian();
        soalAktif += arah;
        if(soalAktif < 0) soalAktif = 0;
        tampilkanSoal();
    }

    function startTimer(menit) {
        let detik = menit * 60;
        timerInterval = setInterval(() => {
            let m = Math.floor(detik / 60);
            let s = detik % 60;
            document.getElementById('timer').innerText = `${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
            if(detik <= 0) selesaiUjian();
            detik--;
        }, 1000);
    }

    async function selesaiUjian() {
        clearInterval(timerInterval);
        document.getElementById('ujianArea').style.display = 'none';
        document.getElementById('hasilArea').style.display = 'block';

        let benar = 0;
        daftarSoal.forEach((s, i) => { if(jawabanSiswa[i] === s.kunci) benar++; });
        const skor = Math.round((benar / daftarSoal.length) * 100);
        document.getElementById('skorDisplay').innerText = skor;

        // PENGIRIMAN DATA KE GOOGLE SHEETS (TARGET: simpanNilai)
        const payload = {
            target: "simpanNilai",
            values: [
                new Date().toLocaleString('id-ID'), // Waktu
                dataSiswa.nama,                    // Nama
                dataSiswa.kelas,                   // Kelas
                daftarSoal[0].mapel,               // Mapel
                skor,                              // Skor
                cheatCount                         // Pelanggaran ESC
            ]
        };

        try {
            await fetch(SCRIPT_URL, { 
                method: "POST", 
                mode: "no-cors", 
                body: JSON.stringify(payload) 
            });
            document.getElementById('statusKirim').innerText = "Data berhasil disimpan!";
        } catch(e) {
            document.getElementById('statusKirim').innerText = "Gagal kirim data, hubungi pengawas.";
        }
    }
</script>
</body>
</html>