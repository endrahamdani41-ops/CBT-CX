<!DOCTYPE html>
<html lang="id" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart CBT - Ujian Siswa</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        :root { 
            --bg-body: #0f172a; --bg-card: #1e293b; --text-main: #f1f5f9; 
            --text-sub: #94a3b8; --border: #334155; --primary: #2563eb; 
            --primary-dark: #1d4ed8; --success: #10b981; --danger: #ef4444; 
        }
        
        body { 
            font-family: 'Inter', sans-serif; background: var(--bg-body); color: var(--text-main); 
            margin: 0; padding: 20px; display: flex; align-items: center; justify-content: center; 
            min-height: 100vh; overflow-x: hidden;
        }

        .container { width: 100%; max-width: 900px; display: flex; flex-direction: column; align-items: center; }

        .card { 
            background: var(--bg-card); padding: 40px; border-radius: 24px; 
            border: 1px solid var(--border); box-shadow: 0 20px 50px rgba(0,0,0,0.3); 
            text-align: center; width: 100%; box-sizing: border-box;
        }

        #login-box { max-width: 450px; }
        h2 { font-weight: 800; color: var(--primary); margin-bottom: 10px; font-size: 1.8rem; text-transform: uppercase; }
        p.sub-title { color: var(--text-sub); margin-bottom: 25px; font-size: 0.95rem; }
        
        input, select { 
            width: 100%; padding: 15px; margin: 10px 0; border-radius: 12px; border: 1px solid var(--border); 
            background: #0f172a; color: white; font-size: 1rem; box-sizing: border-box; text-align: center; 
            transition: border-color 0.3s;
        }

        /* --- PENGHAPUS SPINNER PADA INPUT NIS --- */
        input::-webkit-outer-spin-button,
        input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type=number] {
            -moz-appearance: textfield;
        }

        /* TOMBOL 3D TACTILE */
        .btn, .btn-modal {
            width: 100%; padding: 18px; border: none; border-radius: 12px; font-weight: 800; font-size: 1.1rem;
            cursor: pointer; transition: all 0.1s ease; position: relative; text-transform: uppercase; letter-spacing: 1px;
            background: var(--primary); color: white;
            box-shadow: 0 6px 0 var(--primary-dark);
            margin-top: 15px; margin-bottom: 6px;
        }

        .btn:active, .btn-modal:active {
            transform: translateY(4px);
            box-shadow: 0 2px 0 var(--primary-dark);
        }

        .btn-cancel { background: #334155; box-shadow: 0 6px 0 #1e293b; }
        .btn-cancel:active { box-shadow: 0 2px 0 #1e293b; }

        .btn:disabled {
            background: #1e293b; color: #475569;
            box-shadow: 0 3px 0 #0f172a;
            cursor: not-allowed; transform: none !important;
        }

        .nama-display { 
            background: rgba(16, 185, 129, 0.1); color: var(--success); padding: 15px; border-radius: 12px; 
            font-weight: 700; margin: 15px 0; display: none; border: 1px solid var(--success);
            text-align: center; font-size: 1.2rem; text-transform: uppercase;
        }

        /* HEADER UJIAN */
        #quiz-container { display: none; width: 100%; }
        .header-ujian { 
            display: grid; grid-template-columns: 1fr auto 1fr; align-items: center;
            background: rgba(255,255,255,0.05); padding: 20px; border-radius: 15px; margin-bottom: 30px; border: 1px solid var(--border); 
        }
        
        .header-left { text-align: left; }
        .header-center { display: flex; justify-content: center; }
        .header-right { text-align: right; }

        .timer-box { text-align: center; padding: 10px 20px; background: #0f172a; border-radius: 10px; border: 2px solid var(--primary); }
        #timer { font-size: 1.5rem; font-weight: 800; color: var(--primary); font-variant-numeric: tabular-nums; }

        .opsi-label { 
            display: flex; align-items: center; background: rgba(255,255,255,0.03); 
            padding: 14px 20px; border-radius: 12px; margin-bottom: 10px; 
            cursor: pointer; border: 1px solid var(--border); transition: 0.2s; text-align: left;
        }
        .opsi-label:hover { background: rgba(37, 99, 235, 0.1); border-color: var(--primary); }
        .opsi-label input { width: 20px; height: 20px; margin-right: 15px; accent-color: var(--primary); }

        /* MODAL CUSTOM */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(15, 23, 42, 0.95); backdrop-filter: blur(8px);
            display: none; align-items: center; justify-content: center; z-index: 9999;
        }
        .modal-card {
            background: var(--bg-card); padding: 30px; border-radius: 24px;
            border: 1px solid var(--border); max-width: 400px; width: 90%; text-align: center;
            transform: translateY(20px); transition: 0.3s;
        }
        .modal-overlay.show { display: flex; animation: fadeIn 0.3s forwards; }
        .modal-card.active { transform: translateY(0); }
        .modal-buttons { display: flex; gap: 15px; margin-top: 25px; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>

<div class="container">
    <div id="login-box" class="card">
        <h2>üöÄ LOGIN UJIAN</h2>
        <p class="sub-title">Silakan masukkan NIS dan pilih Mapel.</p>
        <input type="number" id="nis" placeholder="KETIK NIS" oninput="cariNama()">
        <div id="hasil-nama" class="nama-display"></div>
        <select id="mapel" onchange="this.style.borderColor='var(--border)'">
            <option value="" disabled selected>PILIH MATA PELAJARAN</option>
            <option value="PAI">Pendidikan Agama</option>
            <option value="PP">Pendidikan Pancasila</option>
            <option value="B.Indo">Bahasa Indonesia</option>                     
            <option value="Matematika">Matematika</option>
            <option value="IPA">IPA</option>
            <option value="IPS">IPS</option>
            <option value="B.Inggris">Bahasa Inggris</option>
            <option value="PJOK">PJOK</option>
            <option value="Seni Budaya">Seni Budaya</option>
            <option value="Informatika">Informatika</option>
        </select>
        <button id="btn-masuk" class="btn" onclick="mulaiUjian()" disabled>MASUK UJIAN</button>
    </div>

    <div id="quiz-container" class="card">
        <div class="header-ujian">
            <div class="header-left">
                <small style="color:var(--text-sub); display:block; margin-bottom:4px;">PESERTA</small>
                <div id="display-nama" style="font-weight:700; font-size:1.1rem; text-transform: uppercase;">-</div>
            </div>
            <div class="header-center">
                <div id="timer-box" class="timer-box">
                    <small style="color:var(--text-sub)">WAKTU</small>
                    <div id="timer">00:00</div>
                </div>
            </div>
            <div class="header-right">
                <small style="color:var(--text-sub); display:block; margin-bottom:4px;">MAPEL</small>
                <div id="display-mapel" style="font-weight:700; font-size:1.1rem;">-</div>
            </div>
        </div>
        <div id="soal-list"></div>
        <button class="btn" onclick="submitJawaban()" id="btn-submit">KIRIM JAWABAN</button>
    </div>
</div>

<div id="customModal" class="modal-overlay">
    <div class="modal-card">
        <div id="modalIcon" style="font-size: 3.5rem; margin-bottom: 10px;">‚ÑπÔ∏è</div>
        <h3 id="modalTitle" style="margin-bottom: 10px;">Judul</h3>
        <p id="modalMessage" style="color: var(--text-sub); margin-bottom: 20px;">Pesan</p>
        <div class="modal-buttons">
            <button id="modalBtnCancel" class="btn-modal btn-cancel">BATAL</button>
            <button id="modalBtnConfirm" class="btn-modal">OKE</button>
        </div>
    </div>
</div>

<script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbz3eO59ouj3-okVJfW75i_p2974i-QzGlk_xj8DXl5k_r-3oD3xkioXbATAaUVS-vB3/exec"; 
    let dataSoal = [];
    let namaSiswaGlobal = "";
    let durasiDetik = 60 * 60;
    let intervalTimer;

    function shuffle(array) {
        for (let i = array.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [array[i], array[j]] = [array[j], array[i]];
        }
        return array;
    }

    function showModal({ title, message, icon, showCancel, onConfirm }) {
        const modal = document.getElementById('customModal');
        const card = modal.querySelector('.modal-card');
        document.getElementById('modalTitle').innerText = title;
        document.getElementById('modalMessage').innerText = message;
        document.getElementById('modalIcon').innerText = icon || "‚ÑπÔ∏è";
        document.getElementById('modalBtnCancel').style.display = showCancel ? 'block' : 'none';
        modal.classList.add('show');
        setTimeout(() => card.classList.add('active'), 10);
        document.getElementById('modalBtnConfirm').onclick = () => {
            modal.classList.remove('show');
            card.classList.remove('active');
            if (onConfirm) onConfirm();
        };
        document.getElementById('modalBtnCancel').onclick = () => {
            modal.classList.remove('show');
            card.classList.remove('active');
        };
    }

    async function cariNama() {
        const nis = document.getElementById('nis').value;
        const hasil = document.getElementById('hasil-nama');
        const btn = document.getElementById('btn-masuk');
        if (nis.length >= 3) {
            try {
                const res = await fetch(`${SCRIPT_URL}?target=getNama&nis=${nis}`);
                const nama = await res.text();
                if (nama && nama !== "") {
                    namaSiswaGlobal = nama;
                    hasil.innerText = nama;
                    hasil.style.display = 'block';
                    btn.disabled = false;
                } else {
                    hasil.style.display = 'none';
                    btn.disabled = true;
                }
            } catch (e) {}
        }
    }

    async function mulaiUjian() {
        const mapelSelect = document.getElementById('mapel');
        const mapel = mapelSelect.value;
        
        if (!mapel || mapel === "") {
            showModal({ title: "Pilih Mapel", message: "Mata Pelajaran wajib dipilih!", icon: "‚ö†Ô∏è" });
            mapelSelect.style.borderColor = "var(--danger)";
            return;
        }

        const btn = document.getElementById('btn-masuk');
        btn.innerText = "MEMUAT..."; btn.disabled = true;

        try {
            const res = await fetch(`${SCRIPT_URL}?target=dbSoal&mapel=${mapel}`);
            const data = await res.json();
            dataSoal = shuffle(data.filter(s => (s.status || 'AKTIF').toUpperCase() === 'AKTIF'));
            
            if(dataSoal.length === 0) {
                showModal({ title: "Soal Kosong", message: "Tidak ada soal aktif untuk mapel ini.", icon: "üì≠" });
                btn.innerText = "MASUK UJIAN"; btn.disabled = false;
                return;
            }

            document.getElementById('login-box').style.display = 'none';
            document.getElementById('quiz-container').style.display = 'block';
            document.getElementById('display-nama').innerText = namaSiswaGlobal;
            document.getElementById('display-mapel').innerText = mapel;
            renderSoal();
            startTimer();
            window.scrollTo(0,0);
        } catch (e) { 
            showModal({ title: "Error", message: "Gagal menyambung ke server.", icon: "‚ùå" });
            btn.innerText="MASUK UJIAN"; btn.disabled=false; 
        }
    }

    function renderSoal() {
        const list = document.getElementById('soal-list');
        list.innerHTML = dataSoal.map((s, i) => {
            let opsi = shuffle([{ t: s.a, v: "A" }, { t: s.b, v: "B" }, { t: s.c, v: "C" }, { t: s.d, v: "D" }]);
            return `
                <div style="text-align:left; margin-bottom:40px;">
                    <p style="font-size:1.2rem; font-weight:600; margin-bottom:15px;">${i+1}. ${s.pertanyaan}</p>
                    ${opsi.map(o => `<label class="opsi-label"><input type="radio" name="soal${i}" value="${o.v}">${o.t}</label>`).join('')}
                </div><hr style="border:0; border-top:1px solid var(--border); margin:30px 0;">`;
        }).join('');
    }

    function startTimer() {
        intervalTimer = setInterval(() => {
            let m = Math.floor(durasiDetik / 60);
            let s = durasiDetik % 60;
            document.getElementById('timer').innerText = `${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
            if (durasiDetik <= 0) { clearInterval(intervalTimer); submitJawaban(true); }
            durasiDetik--;
        }, 1000);
    }

    async function submitJawaban(isOtomatis = false) {
        const kirim = async () => {
            clearInterval(intervalTimer);
            let benar = 0;
            dataSoal.forEach((s, i) => {
                const terpilih = document.querySelector(`input[name="soal${i}"]:checked`);
                if(terpilih && terpilih.value === s.kunci) benar++;
            });
            const skor = Math.round((benar / dataSoal.length) * 100);
            await fetch(SCRIPT_URL, { method: "POST", mode: "no-cors", body: JSON.stringify({ action: "simpanNilai", nis: document.getElementById('nis').value, nama: namaSiswaGlobal, mapel: document.getElementById('mapel').value, skor: skor }) });
            showModal({ title: "Selesai", message: "Hasil terkirim! Skor Anda: " + skor, icon: "‚úÖ", onConfirm: () => location.reload() });
        };

        if (isOtomatis) kirim();
        else showModal({ title: "Kirim?", message: "Yakin ingin mengakhiri ujian?", icon: "üì§", showCancel: true, onConfirm: kirim });
    }
</script>
</body>
</html>