<!DOCTYPE html>
<html lang="id" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart CBT - Siswa</title>
    <style>
        :root { 
            --bg-body: #0f172a; --bg-card: #1e293b; --text-main: #f1f5f9; 
            --text-sub: #94a3b8; --primary: #2563eb; --primary-hover: #1d4ed8;
            --success: #10b981; --danger: #ef4444; --border: #334155; 
        }
        
        body { font-family: 'Inter', sans-serif; background: var(--bg-body); color: var(--text-main); margin: 0; min-height: 100vh; }

        /* KOTAK LOGIN RATA TENGAH & SIMETRIS */
        .container-center { display: flex; align-items: center; justify-content: center; min-height: 100vh; padding: 20px; }
        .login-card { 
            width: 100%; max-width: 380px; background: var(--bg-card); padding: 40px; 
            border-radius: 24px; border: 1px solid var(--border); text-align: center;
            box-sizing: border-box;
        }

        .form-group { width: 100%; margin-bottom: 20px; box-sizing: border-box; }
        label { display: block; font-size: 0.75rem; font-weight: 700; color: var(--text-sub); text-transform: uppercase; margin-bottom: 10px; }
        
        /* Menyamakan panjang semua elemen input */
        input, select, .btn-blue { 
            width: 100%; /* Panjang sama rata */
            padding: 15px; border-radius: 12px; border: 1px solid var(--border); 
            background: var(--bg-body); color: var(--text-main); 
            font-size: 1rem; box-sizing: border-box; outline: none;
            text-align: center; text-align-last: center;
        }

        .btn-blue { 
            background: var(--primary); border: none; font-weight: 700; cursor: pointer; transition: 0.3s; 
            margin-top: 10px; display: block;
        }
        .btn-blue:hover { background: var(--primary-hover); }
        .btn-blue:disabled { opacity: 0.5; cursor: not-allowed; }

        /* MODAL */
        .modal-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.85); display:none; align-items:center; justify-content:center; z-index:9999; backdrop-filter: blur(8px); }
        .modal-content { background:var(--bg-card); padding:30px; border-radius:20px; text-align:center; max-width:350px; width:90%; border:1px solid var(--border); }

        /* HEADER & UJIAN */
        header { background: rgba(30, 41, 59, 0.9); padding: 15px 30px; border-bottom: 1px solid var(--border); display: none; justify-content: space-between; align-items: center; position: sticky; top:0; }
        #ujianArea, #hasilArea { display: none; padding: 20px; max-width: 800px; margin: auto; }
        .opsi { padding: 15px; border: 1px solid var(--border); border-radius: 12px; cursor: pointer; margin-top: 10px; text-align: left; }
        .opsi.selected { background: var(--primary); color: white; border-color: var(--primary); }
    </style>
</head>
<body>

<div id="customModal" class="modal-overlay">
    <div class="modal-content">
        <h3 id="modalTitle" style="color:var(--primary)">Pesan</h3>
        <p id="modalMessage"></p>
        <button class="btn-blue" onclick="closeModal()">OKE</button>
    </div>
</div>

<div class="container-center" id="loginPage">
    <div class="login-card">
        <h2 style="color:var(--primary); margin-bottom: 30px;">Smart CBT</h2>
        <div class="form-group">
            <label>Nomor Induk Siswa</label>
            <input type="number" id="nisInput" placeholder="Masukkan NIS">
        </div>
        <div class="form-group">
            <label>Mata Pelajaran</label>
            <select id="mapelSelect"><option disabled selected>⏳ Memuat Mapel...</option></select>
        </div>
        <button class="btn-blue" id="btnLogin" onclick="prosesLogin()" disabled>MULAI UJIAN</button>
        <p id="msg" style="font-size:0.8rem; margin-top:15px; color:var(--text-sub)"></p>
    </div>
</div>

<header id="headerUjian">
    <div><b id="dispNama"></b><br><small id="dispKelas"></small></div>
    <div id="timerDisplay" style="font-weight:800; color:var(--danger); font-size:1.5rem;">00:00</div>
</header>

<main id="ujianArea">
    <div style="background:var(--bg-card); padding:30px; border-radius:20px; border:1px solid var(--border);">
        <h4 id="nomorDisplay" style="color:var(--primary); margin:0 0 10px 0;">Soal 1</h4>
        <p id="teksSoal" style="font-size:1.2rem; line-height:1.6; margin-bottom:20px;"></p>
        <div id="opsiContainer"></div>
        <div style="margin-top:30px; display:flex; gap:10px;">
            <button class="btn-blue" style="background:#475569" onclick="navigasi(-1)">KEMBALI</button>
            <button class="btn-blue" id="btnNext" onclick="navigasi(1)">LANJUT</button>
        </div>
    </div>
</main>

<div id="hasilArea" style="text-align:center; padding-top: 50px;">
    <div style="background:var(--bg-card); padding:50px; border-radius:24px; border:1px solid var(--border); display:inline-block;">
        <h2 style="color:var(--success);">Ujian Selesai!</h2>
        <div style="font-size: 4rem; font-weight: 900; margin: 20px 0; color: var(--primary);" id="skorDisplay">0</div>
        <button class="btn-blue" onclick="location.reload()">KELUAR</button>
    </div>
</div>

<script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxvAzR0733dfv1ntFrwo-k4P_4Q6F06cGhxjtUKExxzhA6ROo2pjzp-jZK6nF3zkVmi/exec";
    let allSoal = [], soalFiltered = [], jawabanSiswa = [], currentIdx = 0, timerInterval, userSesi = null;

    window.onload = async () => {
        try {
            const res = await fetch(`${SCRIPT_URL}?target=dbSoal`);
            allSoal = await res.json();
            const listMapel = [...new Set(allSoal.filter(s => String(s.status).toUpperCase() === "AKTIF").map(s => s.mapel))];
            const select = document.getElementById('mapelSelect');
            select.innerHTML = '<option value="" disabled selected>Pilih Mata Pelajaran</option>';
            listMapel.forEach(m => select.innerHTML += `<option value="${m}">${m}</option>`);
            document.getElementById('btnLogin').disabled = false;
        } catch (e) { document.getElementById('msg').innerText = "❌ Gagal koneksi database."; }
    };

    function showModal(title, msg, cb) {
        document.getElementById('modalTitle').innerText = title;
        document.getElementById('modalMessage').innerText = msg;
        document.getElementById('customModal').style.display = 'flex';
        window.modalCb = cb;
    }

    function closeModal() {
        document.getElementById('customModal').style.display = 'none';
        if(window.modalCb) { window.modalCb(); window.modalCb = null; }
    }

    async function prosesLogin() {
        const nis = document.getElementById('nisInput').value;
        const mapel = document.getElementById('mapelSelect').value;
        if(!nis || !mapel) return;

        document.getElementById('msg').innerText = "⏳ Verifikasi...";
        try {
            const res = await fetch(`${SCRIPT_URL}?target=dbSiswa`);
            const dbSiswa = await res.json();
            userSesi = dbSiswa.find(s => String(s.nis).trim() === String(nis).trim());

            if(!userSesi) { showModal("Gagal", "NIS tidak ditemukan."); return; }

            soalFiltered = allSoal.filter(s => {
                const kSiswa = String(userSesi.kelas).trim().toUpperCase();
                const kSoal = String(s.kelas).trim().toUpperCase();
                return s.mapel === mapel && String(s.status).toUpperCase() === "AKTIF" && kSoal.includes(kSiswa);
            });

            if(soalFiltered.length === 0) { showModal("Info", "Soal tidak tersedia untuk kelas Anda."); return; }

            jawabanSiswa = new Array(soalFiltered.length).fill(null);
            document.getElementById('loginPage').style.display = 'none';
            document.getElementById('headerUjian').style.display = 'flex';
            document.getElementById('ujianArea').style.display = 'block';
            document.getElementById('dispNama').innerText = userSesi.nama;
            document.getElementById('dispKelas').innerText = "Kelas " + userSesi.kelas;
            
            mulaiTimer(soalFiltered[0].durasi || 60);
            tampilkanSoal();
        } catch (e) { showModal("Error", "Gagal login."); }
    }

    function tampilkanSoal() {
        const s = soalFiltered[currentIdx];
        document.getElementById('nomorDisplay').innerText = `Soal ${currentIdx + 1} / ${soalFiltered.length}`;
        document.getElementById('teksSoal').innerText = s.pertanyaan;
        const container = document.getElementById('opsiContainer');
        container.innerHTML = '';
        ['a','b','c','d'].forEach(opt => {
            const div = document.createElement('div');
            div.className = `opsi ${jawabanSiswa[currentIdx] === opt.toUpperCase() ? 'selected' : ''}`;
            div.innerHTML = `<b>${opt.toUpperCase()}.</b> ${s[opt]}`;
            div.onclick = () => { jawabanSiswa[currentIdx] = opt.toUpperCase(); tampilkanSoal(); };
            container.appendChild(div);
        });
        document.getElementById('btnNext').innerText = currentIdx === soalFiltered.length - 1 ? "SELESAI" : "LANJUT";
    }

    function navigasi(arah) {
        if(arah === 1 && currentIdx === soalFiltered.length - 1) {
            showModal("Konfirmasi", "Selesaikan ujian dan kirim jawaban?", () => kirimJawaban());
            return;
        }
        let target = currentIdx + arah;
        if(target >= 0 && target < soalFiltered.length) { currentIdx = target; tampilkanSoal(); }
    }

    function mulaiTimer(menit) {
        let detik = menit * 60;
        timerInterval = setInterval(() => {
            let m = Math.floor(detik / 60), s = detik % 60;
            document.getElementById('timerDisplay').innerText = `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
            if(detik-- <= 0) { clearInterval(timerInterval); kirimJawaban(); }
        }, 1000);
    }

    async function kirimJawaban() {
        clearInterval(timerInterval);
        let benar = 0;
        soalFiltered.forEach((s, i) => { if(jawabanSiswa[i] === String(s.kunci).toUpperCase()) benar++; });
        const skor = Math.round((benar / soalFiltered.length) * 100);
        
        document.getElementById('skorDisplay').innerText = skor;
        document.getElementById('ujianArea').style.display = 'none';
        document.getElementById('headerUjian').style.display = 'none';
        document.getElementById('hasilArea').style.display = 'block';

        fetch(SCRIPT_URL, {
            method: "POST",
            body: JSON.stringify({
                action: "simpanNilai",
                nis: userSesi.nis,
                nama: userSesi.nama,
                kelas: userSesi.kelas,
                mapel: soalFiltered[0].mapel,
                benar: benar,
                salah: soalFiltered.length - benar,
                skor: skor
            })
        });
    }
</script>
</body>
</html>