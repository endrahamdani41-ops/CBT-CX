<!DOCTYPE html>
<html lang="id" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart CBT - Professional Edition</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        :root { 
            --bg-body: #050a18; 
            --bg-card: rgba(30, 41, 59, 0.7); 
            --text-main: #f8fafc; 
            --text-sub: #94a3b8; 
            --border: rgba(255, 255, 255, 0.1); 
            --primary: #3b82f6; 
            --primary-glow: rgba(59, 130, 246, 0.4);
            --success: #10b981; 
            --danger: #ef4444; 
        }
        
        body { 
            font-family: 'Plus Jakarta Sans', sans-serif; 
            background: radial-gradient(circle at top right, #1e293b, #050a18);
            color: var(--text-main); 
            margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; 
            min-height: 100vh;
        }

        /* HAPUS SPINNER DI INPUT NUMBER (NIS) */
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { 
            -webkit-appearance: none; 
            margin: 0; 
        }
        input[type=number] {
            -moz-appearance: textfield; /* Untuk Firefox */
        }

        /* FIX UNTUK FULLSCREEN MODE */
        :fullscreen, ::-webkit-full-screen, :-ms-fullscreen {
            background: #050a18 !important;
            width: 100vw;
            height: 100vh;
            overflow-y: auto;
            padding: 20px;
            box-sizing: border-box;
        }

        .container { width: 100%; max-width: 450px; transition: all 0.6s cubic-bezier(0.34, 1.56, 0.64, 1); }
        .container.ujian-mode { max-width: 850px; }

        #login-box.card { 
            background: var(--bg-card); padding: 50px 40px; border-radius: 32px; 
            border: 1px solid var(--border); backdrop-filter: blur(16px);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5), 0 0 20px var(--primary-glow); 
            text-align: center;
        }

        input, select, .btn, #hasil-nama { 
            width: 100%; padding: 18px; margin: 12px 0; border-radius: 18px; 
            border: 1px solid var(--border); background: rgba(15, 23, 42, 0.8); color: white; 
            box-sizing: border-box; text-align: center; font-size: 1rem; transition: 0.3s;
        }

        .btn { cursor: pointer; border: none; font-weight: 800; }
        .btn:hover:not(:disabled) { transform: translateY(-2px); filter: brightness(1.1); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }

        .soal-item { 
            background: var(--bg-card); padding: 35px; border-radius: 28px; 
            border: 1px solid var(--border); margin-bottom: 25px; backdrop-filter: blur(10px);
        }
        
        .soal-teks { font-size: 1.25rem; font-weight: 700; margin-bottom: 30px; line-height: 1.6; display: block; }
        .opsi-container { display: flex; flex-direction: column; gap: 12px; }
        .opsi-label { 
            display: flex; align-items: center; gap: 15px;
            padding: 20px 25px; background: rgba(255, 255, 255, 0.03); 
            border: 1px solid var(--border); border-radius: 20px; 
            cursor: pointer; transition: 0.2s ease; 
        }
        .opsi-label:hover { background: rgba(59, 130, 246, 0.1); border-color: var(--primary); transform: translateX(8px); }
        .opsi-label input[type="radio"] { width: 22px; height: 22px; accent-color: var(--primary); flex-shrink: 0; }
        .opsi-teks { font-size: 1.05rem; color: var(--text-main); font-weight: 500; text-align: left; }

        .modal-overlay {
            position: fixed; inset: 0; background: rgba(2, 6, 23, 0.85); 
            backdrop-filter: blur(12px); display: flex; align-items: center; justify-content: center;
            z-index: 9999; opacity: 0; pointer-events: none; transition: 0.4s;
        }
        .modal-overlay.active { opacity: 1; pointer-events: auto; }
        .modal-box {
            background: #1e293b; padding: 45px; border-radius: 35px;
            max-width: 420px; width: 90%; text-align: center; border: 1px solid var(--border);
        }

        .sticky-header { 
            position: sticky; top: 0; background: rgba(15, 23, 42, 0.9); 
            padding: 20px 30px; border: 1px solid var(--border); border-bottom: 4px solid var(--primary);
            margin-bottom: 30px; display: flex; justify-content: space-between; align-items: center; 
            border-radius: 24px; backdrop-filter: blur(20px); z-index: 10;
        }
    </style>
</head>
<body>

<div class="modal-overlay" id="customModal">
    <div class="modal-box">
        <span id="mIcon" style="font-size: 4.5rem; display: block; margin-bottom: 15px;">‚ö†Ô∏è</span>
        <h2 id="mTitle" style="margin: 0; font-weight: 800;">Peringatan</h2>
        <p id="mDesc" style="color: var(--text-sub); line-height: 1.5; margin: 15px 0 25px 0;"></p>
        <div id="vCounter" style="background: rgba(239, 68, 68, 0.1); color: var(--danger); padding: 12px; border-radius: 12px; font-weight: 800; display: none; margin-bottom: 20px; border: 1px solid var(--danger);">
            Pelanggaran: <span id="vHitung">0</span> / 3
        </div>
        <div style="display: flex; gap: 12px;">
            <button class="btn" id="btnBatal" style="background: rgba(255,255,255,0.05); color:white; padding:15px; flex:1; display: none;" onclick="tutupModal()">BATAL</button>
            <button class="btn" id="btnOk" style="background: var(--primary); color:white; padding:15px; flex:1;" onclick="tutupModal()">MENGERTI</button>
        </div>
    </div>
</div>

<div class="container" id="main-container">
    <div id="login-box" class="card">
        <h2 style="font-weight: 800; font-size: 2.2rem; margin: 0;">SMART <span style="color: var(--primary);">CBT</span></h2>
        <p style="color: var(--text-sub); margin-bottom: 35px;">Digital Examination System</p>
        <input type="number" id="nis" placeholder="Masukkan NIS" oninput="inputHandler()">
        <div id="hasil-nama" style="display:none; margin: 10px 0; font-weight: 800;"></div>
        <select id="mapel">
            <option value="" disabled selected>Pilih Mata Pelajaran</option>
            <option value="PAI">Pendidikan Agama</option>
            <option value="PP">Pendidikan Pancasila</option>
            <option value="B.Indo">Bahasa Indonesia</option>                     
            <option value="Matematika">Matematika</option>
            <option value="IPA">IPA</option>
            <option value="IPS">IPS</option>
            <option value="B.Inggris">Bahasa Inggris</option>
            <option value="PJOK">PJOK</option>
            <option value="Seni Budaya">Seni Budaya</option>
            <option value="Informatika">Informatika</option>
        </select>
        <button id="btn-masuk" class="btn" style="background: var(--primary); height: 65px; color:white; width:100%;" disabled onclick="mulaiUjianFull()">MULAI UJIAN üöÄ</button>
    </div>

    <div id="ujian-section" style="display: none; width: 100%;">
        <div class="sticky-header">
            <div style="text-align: left;">
                <b id="info-mapel" style="color:var(--primary); font-size: 0.8rem; text-transform: uppercase;">MAPEL</b>
                <div id="info-nama" style="font-weight: 800; font-size: 1.1rem;"></div>
            </div>
            <div id="timer" style="font-size: 1.5rem; font-weight: 800; color: var(--danger);">60:00</div>
        </div>
        <div id="wadah-soal"></div>
        <button class="btn" style="background: var(--success); padding: 25px; color:white; width:100%; border-radius: 20px;" onclick="tanyaSelesai()">‚úÖ KIRIM JAWABAN</button>
    </div>
</div>

<script>
    function requestFullScreen() {
        const el = document.documentElement;
        if (el.requestFullscreen) el.requestFullscreen();
        else if (el.webkitRequestFullscreen) el.webkitRequestFullscreen();
        else if (el.msRequestFullscreen) el.msRequestFullscreen();
    }

    function mulaiUjianFull() {
        requestFullScreen();
        mulaiUjian(); 
    }

    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwIrgRGQadp68Qz1wtVM9xbUNAMkov2T-_eSG44MjM10lkouGvHcRt71Hf3Z_aOjRim/exec"; 
    let namaSiswaGlobal = "", kelasSiswaGlobal = "", nisSiswaGlobal = "", dataSoalGlobal = [], jmlPelanggaran = 0, sedangUjian = false;

    function showModal(title, desc, icon = "‚ö†Ô∏è", showBatal = false, onOk = null, isCheat = false) {
        document.getElementById('mTitle').innerText = title;
        document.getElementById('mDesc').innerText = desc;
        document.getElementById('mIcon').innerText = icon;
        document.getElementById('btnBatal').style.display = showBatal ? 'block' : 'none';
        document.getElementById('vCounter').style.display = isCheat ? 'block' : 'none';
        const btnOk = document.getElementById('btnOk');
        btnOk.onclick = () => { tutupModal(); if(onOk) onOk(); };
        document.getElementById('customModal').classList.add('active');
    }
    function tutupModal() { document.getElementById('customModal').classList.remove('active'); }

    async function inputHandler() {
        const nis = document.getElementById('nis').value;
        if (nis.length < 3) return;
        try {
            const res = await fetch(`${SCRIPT_URL}?target=getNama&nis=${nis}`);
            const data = await res.json();
            if (data && data.NAMA) {
                nisSiswaGlobal = nis; namaSiswaGlobal = data.NAMA; kelasSiswaGlobal = data.KELAS;
                const h = document.getElementById('hasil-nama');
                h.innerText = data.NAMA; h.style.display = 'block'; h.style.color = 'var(--success)';
                document.getElementById('btn-masuk').disabled = false;
            }
        } catch (e) {}
    }

    async function mulaiUjian() {
        const mapel = document.getElementById('mapel').value;
        if(!mapel) return;
        document.getElementById('btn-masuk').innerText = "MENYIAPKAN...";
        try {
            const kls = kelasSiswaGlobal.toString().match(/\d+/)[0];
            const res = await fetch(`${SCRIPT_URL}?target=dbSoal&mapel=${mapel}&kelas=${kls}`);
            dataSoalGlobal = await res.json();
            sedangUjian = true;
            document.getElementById('main-container').classList.add('ujian-mode');
            document.getElementById('login-box').style.display = 'none';
            document.getElementById('ujian-section').style.display = 'block';
            document.getElementById('info-mapel').innerText = mapel;
            document.getElementById('info-nama').innerText = namaSiswaGlobal;
            renderSoal();
            aktifkanAntiCheat();
        } catch (e) { alert("Gagal memuat soal"); }
    }

    function renderSoal() {
        let html = "";
        dataSoalGlobal.forEach((s, i) => {
            html += `<div class="soal-item"><span class="soal-teks">${i+1}. ${s.soal || s.pertanyaan}</span><div class="opsi-container">${['A', 'B', 'C', 'D'].map(opt => `<label class="opsi-label"><input type="radio" name="q${i}" value="${opt}"><div class="opsi-teks">${s[opt.toLowerCase()] || s[opt]}</div></label>`).join('')}</div></div>`;
        });
        document.getElementById('wadah-soal').innerHTML = html;
    }

    function aktifkanAntiCheat() {
        document.addEventListener("visibilitychange", () => {
            if (document.hidden && sedangUjian) {
                jmlPelanggaran++;
                document.getElementById('vHitung').innerText = jmlPelanggaran;
                showModal("Peringatan!", "Jangan keluar halaman!", "üö´", false, null, true);
                if(jmlPelanggaran >= 3) showModal("Diskualifikasi", "Batas pelanggaran habis.", "‚ùå", false, () => location.reload());
            }
        });
    }

    function tanyaSelesai() { showModal("Kirim Jawaban?", "Pastikan sudah selesai.", "üèÅ", true, () => location.reload()); }
</script>
</body>
</html>