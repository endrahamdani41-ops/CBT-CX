<!DOCTYPE html>
<html lang="id" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ujian Siswa - Smart CBT</title>
    <style>
        :root { 
            --bg-body: #0f172a; 
            --bg-card: #1e293b; 
            --text-main: #f1f5f9; 
            --text-sub: #94a3b8; 
            --border: rgba(255,255,255,0.1); 
            --primary: #0ea5e9; 
            --success: #10b981; 
            --danger: #ef4444; 
        }

        body { font-family: 'Inter', sans-serif; background: var(--bg-body); color: var(--text-main); margin: 0; padding: 0; overflow: hidden; }

        /* --- LOGIN CARD DENGAN GAMBAR FULL --- */
        .container { width: 100vw; height: 100vh; display: flex; align-items: center; justify-content: center; }
        
        .login-box { 
            text-align: center; 
            max-width: 360px; 
            width: 90%; 
            padding: 40px 30px; 
            border-radius: 24px; 
            position: relative;
            overflow: hidden;
            /* Gambar Latar Belakang Full */
            background: linear-gradient(135deg, rgba(14, 165, 233, 0.85), rgba(15, 23, 42, 0.95)), 
                        url('https://images.unsplash.com/photo-1606326666333-440266006764?q=80&w=1000');
            background-size: cover;
            background-position: center;
            border: 1px solid var(--border);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        }

        /* INPUT TANPA SPINNER */
        input { 
            width: 100%; padding: 14px; margin: 10px 0; border-radius: 12px; 
            border: 1px solid rgba(255,255,255,0.2); background: rgba(15, 23, 42, 0.6); 
            color: white; text-align: center; font-size: 1rem; box-sizing: border-box;
            backdrop-filter: blur(4px);
        }
        input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        input[type=number] { -moz-appearance: textfield; }

        .btn { 
            width: 100%; padding: 14px; border: none; border-radius: 12px; cursor: pointer; 
            font-weight: 800; background: #22c55e; color: white; transition: 0.3s; 
        }

        /* --- VIEW SOAL FULL SCREEN --- */
        #viewSoal { position: fixed; inset: 0; background: #0f172a; z-index: 1000; display: none; flex-direction: column; }
        .soal-header { height: 65px; background: #1e293b; display: flex; align-items: center; justify-content: space-between; padding: 0 25px; }
        .soal-content { flex: 1; overflow-y: auto; padding: 40px 20px; display: flex; flex-direction: column; align-items: center; }
        
        /* Lebar Gambar Sama Dengan Kotak Pilihan */
        .soal-wrapper { max-width: 800px; width: 100%; margin: 0 auto; }
        .soal-img-container { width: 100%; border-radius: 15px; overflow: hidden; margin-bottom: 20px; border: 1px solid var(--border); }
        .soal-img { width: 100%; height: auto; display: block; object-fit: cover; }

        .opsi { 
            display: flex; align-items: center; gap: 15px; padding: 18px; border: 2px solid #334155; 
            border-radius: 15px; margin-bottom: 12px; cursor: pointer; width: 100%; box-sizing: border-box; 
        }
        .opsi.selected { background: var(--primary); color: white; border-color: var(--primary); }

        /* --- MODAL ELEGAN --- */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); backdrop-filter: blur(8px); z-index: 99999; display: none; align-items: center; justify-content: center; }
        .modal-box { background: #1e293b; padding: 35px; border-radius: 24px; max-width: 380px; width: 90%; text-align: center; border: 1px solid var(--border); transform: scale(0.9); transition: 0.3s; }
        .modal-box.active { transform: scale(1); }
    </style>
</head>
<body>

<div id="customModal" class="modal-overlay">
    <div class="modal-box" id="modalBox">
        <div id="modalIcon" style="font-size: 4rem; margin-bottom: 15px;">üîî</div>
        <h3 id="modalTitle">Judul</h3>
        <p id="modalMsg">Pesan...</p>
        <div style="display: flex; gap: 12px; margin-top: 25px;">
            <button id="btnCancel" class="btn" style="background: transparent; border: 1px solid var(--border);" onclick="closeModal()">Batal</button>
            <button id="btnConfirm" class="btn" style="background: var(--primary);">Oke</button>
        </div>
    </div>
</div>

<div class="container">
    <div id="viewLogin" class="login-box">
        <div style="font-size: 45px;">üéì</div>
        <h2>Smart CBT</h2>
        <p>Sistem Ujian Kehadiran Siswa</p>
        <input type="number" id="nisInput" placeholder="Masukkan NIS">
        <button class="btn" onclick="loginSiswa()" id="btnLogin">MASUK UJIAN</button>
    </div>

    <div id="viewListUjian" style="display: none; width: 90%; max-width: 550px;">
        <h3 style="text-align: center;">Pilih Mata Pelajaran</h3>
        <div id="listUjianContainer"></div>
    </div>
</div>

<div id="viewSoal">
    <div class="soal-header">
        <div id="txtMapel" style="font-weight: 800; color: var(--primary);">UJIAN</div>
        <div id="timerBox" style="background: var(--danger); padding: 5px 15px; border-radius: 20px;">00:00</div>
        <div style="text-align: right; font-size: 0.8rem;"><b id="txtNamaSiswa">NAMA</b><br><span id="txtKelasSiswa">KELAS</span></div>
    </div>
    <div class="soal-content">
        <div class="soal-wrapper" id="soalContainer"></div>
    </div>
    <div style="height: 80px; display: flex; justify-content: center; gap: 20px; align-items: center; background: #1e293b;">
        <button class="btn" style="width: 120px; background: #334155;" onclick="prevSoal()">KEMBALI</button>
        <div id="soalIndicator" style="font-weight: 800;">1 / 10</div>
        <button id="btnNext" class="btn" style="width: 120px; background: var(--primary);" onclick="nextSoal()">LANJUT</button>
        <button id="btnSelesai" class="btn" style="width: 120px; background: var(--success); display: none;" onclick="finishUjian()">SELESAI</button>
    </div>
</div>

<script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbw5nxp2bZzENzuGCjlBMJ2r49JMOSoczCEtLHFilRGlyaCnbJhWGQQ5v5oktT4Upsji/exec";
    let user, allSoal, activeSoal, currentIdx = 0, answers = {}, timerInterval;

    function openModal(title, msg, icon, type = 'alert', onConfirm = null) {
        document.getElementById('modalTitle').innerText = title;
        document.getElementById('modalMsg').innerText = msg;
        document.getElementById('modalIcon').innerText = icon;
        document.getElementById('btnCancel').style.display = type === 'confirm' ? 'block' : 'none';
        document.getElementById('btnConfirm').onclick = () => { closeModal(); if(onConfirm) onConfirm(); };
        document.getElementById('customModal').style.display = 'flex';
        setTimeout(() => document.getElementById('modalBox').classList.add('active'), 10);
    }
    function closeModal() {
        document.getElementById('modalBox').classList.remove('active');
        setTimeout(() => document.getElementById('customModal').style.display = 'none', 200);
    }

    // Aktifkan Full Screen
    function activateFullScreen() {
        const doc = document.documentElement;
        if (doc.requestFullscreen) doc.requestFullscreen();
    }

    async function loginSiswa() {
        const nis = document.getElementById('nisInput').value;
        if(!nis) return openModal("Peringatan", "Masukkan NIS Anda.", "‚ö†Ô∏è");
        const btn = document.getElementById('btnLogin');
        btn.innerText = "Mengecek..."; btn.disabled = true;
        try {
            const res = await fetch(`${SCRIPT_URL}?target=dbSiswa`);
            const students = await res.json();
            user = students.find(s => s.nis == nis);
            if(user) {
                document.getElementById('viewLogin').style.display = 'none';
                document.getElementById('viewListUjian').style.display = 'block';
                document.getElementById('txtNamaSiswa').innerText = user.nama.toUpperCase();
                document.getElementById('txtKelasSiswa').innerText = user.kelas;
                loadDaftarUjian();
            } else {
                openModal("Gagal", "NIS tidak ditemukan.", "‚ùå");
                btn.innerText = "MASUK UJIAN"; btn.disabled = false;
            }
        } catch(e) { openModal("Error", "Koneksi gagal.", "üì°"); btn.innerText = "MASUK UJIAN"; btn.disabled = false; }
    }

    async function loadDaftarUjian() {
        const container = document.getElementById('listUjianContainer');
        container.innerHTML = "<p style='text-align:center'>Memuat...</p>";
        const res = await fetch(`${SCRIPT_URL}?target=dbSoal`);
        allSoal = await res.json();
        container.innerHTML = "";
        const mapelUnik = [...new Set(allSoal.map(s => s.mapel))];
        mapelUnik.forEach(m => {
            const soalTersedia = allSoal.filter(s => s.mapel === m && s.kelas.includes(user.kelas));
            if(soalTersedia.length > 0) {
                const div = document.createElement('div');
                div.innerHTML = `<div style="background:#1e293b; padding:20px; border-radius:18px; margin-bottom:15px; display:flex; justify-content:space-between; align-items:center; border:1px solid var(--border);">
                    <div><b>${m}</b><br><small>${soalTersedia.length} Soal</small></div>
                    <button class="btn" style="width:auto; padding:8px 20px;" onclick="konfirmasiMulai('${m}')">MULAI</button>
                </div>`;
                container.appendChild(div);
            }
        });
    }

    function konfirmasiMulai(m) {
        openModal("Mulai Ujian?", `Ujian ${m} akan segera dimulai dalam mode Full Screen.`, "üìù", "confirm", () => {
            activateFullScreen();
            startUjian(m);
        });
    }

    function startUjian(mapel) {
        activeSoal = allSoal.filter(s => s.mapel === mapel && s.kelas.includes(user.kelas));
        document.getElementById('viewListUjian').style.display = 'none';
        document.getElementById('viewSoal').style.display = 'flex';
        document.getElementById('txtMapel').innerText = mapel.toUpperCase();
        renderSoal();
        startTimer(activeSoal[0].durasi);
    }

    function renderSoal() {
        const s = activeSoal[currentIdx];
        document.getElementById('soalIndicator').innerText = `${currentIdx + 1} / ${activeSoal.length}`;
        // Gambar sejajar dengan opsi
        let imgHtml = s.gambar ? `<div class="soal-img-container"><img src="${s.gambar}" class="soal-img"></div>` : '';
        document.getElementById('soalContainer').innerHTML = `
            <div class="soal-text">${s.pertanyaan}</div>
            ${imgHtml}
            <div class="opsi ${answers[currentIdx] === 'A' ? 'selected' : ''}" onclick="pilih('A')"><span>A.</span> ${s.opta}</div>
            <div class="opsi ${answers[currentIdx] === 'B' ? 'selected' : ''}" onclick="pilih('B')"><span>B.</span> ${s.optb}</div>
            <div class="opsi ${answers[currentIdx] === 'C' ? 'selected' : ''}" onclick="pilih('C')"><span>C.</span> ${s.optc}</div>
            <div class="opsi ${answers[currentIdx] === 'D' ? 'selected' : ''}" onclick="pilih('D')"><span>D.</span> ${s.optd}</div>
        `;
        document.getElementById('btnNext').style.display = currentIdx === activeSoal.length - 1 ? 'none' : 'block';
        document.getElementById('btnSelesai').style.display = currentIdx === activeSoal.length - 1 ? 'block' : 'none';
    }

    function pilih(v) { answers[currentIdx] = v; renderSoal(); }
    function nextSoal() { if(currentIdx < activeSoal.length - 1) { currentIdx++; renderSoal(); } }
    function prevSoal() { if(currentIdx > 0) { currentIdx--; renderSoal(); } }

    function startTimer(mnt) {
        let sec = mnt * 60;
        timerInterval = setInterval(() => {
            let m = Math.floor(sec / 60); let s = sec % 60;
            document.getElementById('timerBox').innerText = `${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
            if(sec-- <= 0) { clearInterval(timerInterval); finishUjian(true); }
        }, 1000);
    }

    async function finishUjian(auto = false) {
        const kirim = async () => {
            clearInterval(timerInterval);
            document.getElementById('viewSoal').innerHTML = "<h3>Mengirim hasil...</h3>";
            let benar = 0; activeSoal.forEach((s, i) => { if(answers[i] === s.kunci) benar++; });
            const skor = Math.round((benar / activeSoal.length) * 100);
            await fetch(SCRIPT_URL, { method: "POST", body: JSON.stringify({ target: "simpanNilai", values: [new Date().toLocaleString('id-ID'), user.nama, user.kelas, activeSoal[0].mapel, skor, 0] }) });
            location.reload();
        };
        if(auto) kirim();
        else openModal("Kirim Jawaban?", "Pastikan semua sudah terisi.", "üöÄ", "confirm", kirim);
    }
</script>
</body>
</html>