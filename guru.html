<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart CBT v3 - Guru Panel</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        :root { 
            --bg: #050a18; --card: #1e293b; --text: #f8fafc; 
            --primary: #3b82f6; --border: rgba(59, 130, 246, 0.3); 
            --success: #10b981; --danger: #ef4444; --warning: #f59e0b;
        }
        
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: var(--bg); color: var(--text); margin: 0; }
        .container { max-width: 1000px; margin: 20px auto; padding: 0 20px; display: none; }
        .card { background: var(--card); padding: 25px; border-radius: 20px; border: 1px solid var(--border); margin-bottom: 20px; }
        .section { display: none; }
        .section.active { display: block; }

        label { display: block; margin-top: 15px; font-weight: 600; color: var(--primary); font-size: 0.85rem; text-transform: uppercase; }
        input, select, textarea { width: 100%; padding: 12px; margin: 8px 0; border-radius: 10px; border: 1px solid var(--border); background: #0f172a; color: white; box-sizing: border-box; font-family: inherit; }

        /* Multiselect Dropdown */
        .multiselect { position: relative; margin-bottom: 15px; }
        .select-box { background: #0f172a; border: 1px solid var(--border); padding: 12px; border-radius: 10px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
        .checkbox-wrapper { display: none; position: absolute; width: 100%; background: #1e293b; border: 1px solid var(--primary); z-index: 1000; border-radius: 10px; padding: 15px; box-sizing: border-box; box-shadow: 0 10px 30px rgba(0,0,0,0.5); max-height: 380px; overflow-y: auto; }
        
        .kelas-group-title { font-size: 0.75rem; font-weight: 800; color: var(--primary); margin: 12px 0 8px 0; border-bottom: 1px solid rgba(59, 130, 246, 0.2); padding-bottom: 5px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
        .kelas-group-title:hover { color: white; }

        /* REVISI: Kerapatan Checkbox */
        .kelas-grid-mini { 
            display: grid; 
            grid-template-columns: repeat(6, 1fr); /* 6 Kolom agar rapat ke samping */
            gap: 5px; 
            margin-bottom: 10px; 
        }
        .kelas-grid-mini label { 
            display: flex; 
            align-items: center; 
            gap: 4px; /* Jarak kotak ke teks dirapatkan */
            font-size: 0.8rem; 
            color: #fff; 
            cursor: pointer; 
            margin: 0; 
            text-transform: none; 
            white-space: nowrap;
        }
        .kelas-grid-mini input[type="checkbox"] { 
            width: 15px; 
            height: 15px; 
            margin: 0; 
            cursor: pointer; 
        }

        .table-container { overflow-x: auto; margin-top: 15px; }
        table { width: 100%; border-collapse: collapse; background: #0f172a; border-radius: 12px; font-size: 0.85rem; }
        th, td { padding: 12px; border-bottom: 1px solid var(--border); text-align: left; }
        th { background: rgba(59, 130, 246, 0.1); color: var(--primary); }
        
        .btn-main { width: 100%; padding: 15px; border-radius: 12px; border: none; background: var(--primary); color: white; font-weight: 800; cursor: pointer; transition: 0.3s; margin-top: 15px; }
        .btn-icon { border: none; background: none; cursor: pointer; font-size: 1.1rem; padding: 5px; }
        .btn-edit { color: var(--warning); }
        .btn-delete { color: var(--danger); }

        .navbar { display: none; background: var(--card); padding: 12px; border-bottom: 1px solid var(--border); justify-content: center; gap: 15px; position: sticky; top: 0; z-index: 100; }
        .nav-btn { padding: 8px 18px; border-radius: 8px; border: none; background: transparent; color: var(--text); cursor: pointer; font-weight: 600; }
        .nav-btn.active { background: var(--primary); color: white; }
    </style>
</head>
<body>

    <div id="access-gate" style="display: flex; height: 100vh; align-items: center; justify-content: center;">
        <div class="card" style="width: 350px; text-align: center;">
            <h2 style="margin-bottom:20px">PANEL GURU CBT</h2>
            <input type="password" id="access-code" placeholder="Masukkan Kode Guru">
            <button class="btn-main" onclick="verifikasiAkses()">LOGIN</button>
        </div>
    </div>

    <div id="guru-nav" class="navbar">
        <button class="nav-btn active" id="nav-input" onclick="showSection('buat-soal', this)">BUAT SOAL</button>
        <button class="nav-btn" onclick="showSection('daftar-soal', this); muatDaftarSoal()">BANK SOAL</button>
        <button class="nav-btn" onclick="showSection('rekap-nilai', this); muatRekapNilai()">REKAP NILAI</button>
        <button class="nav-btn" style="color:var(--danger)" onclick="location.reload()"><i class="fas fa-power-off"></i></button>
    </div>

    <div id="guru-container" class="container">
        
        <div id="buat-soal" class="section active card">
            <h3 id="form-title" style="margin-top:0">üìù Input Soal</h3>
            <input type="hidden" id="edit-id">

            <label>Mata Pelajaran</label>
            <select id="mapel-guru">
                <option value="" disabled selected>Pilih Mata Pelajaran</option>
                <option value="PAI">Pendidikan Agama</option>
                <option value="PP">Pendidikan Pancasila</option>
                <option value="B.Indo">Bahasa Indonesia</option>
                <option value="Matematika">Matematika</option>
                <option value="IPA">IPA</option>
                <option value="IPS">IPS</option>
                <option value="B.Inggris">Bahasa Inggris</option>
                <option value="PJOK">PJOK</option>
                <option value="Seni Budaya">Seni Budaya</option>
                <option value="Informatika">Informatika</option>
            </select>

            <label>Tujuan Kelas (Klik Tingkat untuk Semua)</label>
            <div class="multiselect">
                <div class="select-box" onclick="toggleKelas()">
                    <span id="label-pilih-kelas">Pilih Kelas ‚ñº</span>
                </div>
                <div id="checkboxes-kelas" class="checkbox-wrapper">
                    <div class="kelas-group-title" onclick="pilihSemuaTingkat('7')">TINGKAT 7 <i class="fas fa-check-double"></i></div>
                    <div class="kelas-grid-mini" id="grup-7">
                        <label><input type="checkbox" class="kelas-opt" value="7A">7A</label>
                        <label><input type="checkbox" class="kelas-opt" value="7B">7B</label>
                        <label><input type="checkbox" class="kelas-opt" value="7C">7C</label>
                        <label><input type="checkbox" class="kelas-opt" value="7D">7D</label>
                        <label><input type="checkbox" class="kelas-opt" value="7E">7E</label>
                        <label><input type="checkbox" class="kelas-opt" value="7F">7F</label>
                    </div>
                    <div class="kelas-group-title" onclick="pilihSemuaTingkat('8')">TINGKAT 8 <i class="fas fa-check-double"></i></div>
                    <div class="kelas-grid-mini" id="grup-8">
                        <label><input type="checkbox" class="kelas-opt" value="8A">8A</label>
                        <label><input type="checkbox" class="kelas-opt" value="8B">8B</label>
                        <label><input type="checkbox" class="kelas-opt" value="8C">8C</label>
                        <label><input type="checkbox" class="kelas-opt" value="8D">8D</label>
                        <label><input type="checkbox" class="kelas-opt" value="8E">8E</label>
                        <label><input type="checkbox" class="kelas-opt" value="8F">8F</label>
                    </div>
                    <div class="kelas-group-title" onclick="pilihSemuaTingkat('9')">TINGKAT 9 <i class="fas fa-check-double"></i></div>
                    <div class="kelas-grid-mini" id="grup-9">
                        <label><input type="checkbox" class="kelas-opt" value="9A">9A</label>
                        <label><input type="checkbox" class="kelas-opt" value="9B">9B</label>
                        <label><input type="checkbox" class="kelas-opt" value="9C">9C</label>
                        <label><input type="checkbox" class="kelas-opt" value="9D">9D</label>
                        <label><input type="checkbox" class="kelas-opt" value="9E">9E</label>
                        <label><input type="checkbox" class="kelas-opt" value="9F">9F</label>
                    </div>
                </div>
            </div>

            <label>Pertanyaan</label>
            <textarea id="pertanyaan" rows="3" placeholder="Masukkan soal..."></textarea>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                <div><label>Opsi A</label><input type="text" id="opsi-a"></div>
                <div><label>Opsi B</label><input type="text" id="opsi-b"></div>
                <div><label>Opsi C</label><input type="text" id="opsi-c"></div>
                <div><label>Opsi D</label><input type="text" id="opsi-d"></div>
            </div>

            <label>Kunci</label>
            <select id="kunci-jawaban">
                <option value="A">A</option><option value="B">B</option><option value="C">C</option><option value="D">D</option>
            </select>

            <button class="btn-main" id="btn-submit" onclick="simpanSoal()">SIMPAN DATA</button>
            <button class="btn-main" id="btn-batal" onclick="bersihkanForm()" style="background:#475569; display:none; margin-top:5px">BATAL EDIT</button>
        </div>

        <div id="daftar-soal" class="section card"><h3>üìÇ Bank Soal</h3><div class="table-container" id="wadah-daftar-soal"></div></div>
        <div id="rekap-nilai" class="section card"><h3>üìä Rekap Nilai</h3><div class="table-container" id="wadah-rekap"></div></div>
    </div>

<script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzCVmxzK7KS3j14EJ7JGyFCSxnOpB8bLG76a67DG1S9630injt4MHs98A59RIoW95JZWQ/exec"; 
    const KODE_GURU = "GURU110";

    function verifikasiAkses() {
        if(document.getElementById('access-code').value === KODE_GURU) {
            document.getElementById('access-gate').style.display = 'none';
            document.getElementById('guru-nav').style.display = 'flex';
            document.getElementById('guru-container').style.display = 'block';
        } else { Swal.fire("Gagal", "Kode Salah!", "error"); }
    }

    function toggleKelas() {
        const w = document.getElementById("checkboxes-kelas");
        w.style.display = w.style.display === "block" ? "none" : "block";
    }

    function pilihSemuaTingkat(tingkat) {
        const grup = document.getElementById(`grup-${tingkat}`);
        const cbs = grup.querySelectorAll('.kelas-opt');
        const anyUnchecked = Array.from(cbs).some(cb => !cb.checked);
        cbs.forEach(cb => cb.checked = anyUnchecked);
        updateLabelKelas();
    }

    function updateLabelKelas() {
        const checked = Array.from(document.querySelectorAll('.kelas-opt:checked')).map(c => c.value);
        document.getElementById('label-pilih-kelas').innerText = checked.length > 0 ? checked.join(', ') : "Pilih Kelas ‚ñº";
    }

    document.querySelectorAll('.kelas-opt').forEach(cb => cb.addEventListener('change', updateLabelKelas));

    function showSection(id, btn) {
        document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        btn.classList.add('active');
        document.getElementById("checkboxes-kelas").style.display = "none";
    }

    async function simpanSoal() {
        const kls = Array.from(document.querySelectorAll('.kelas-opt:checked')).map(c => c.value).join(',');
        const payload = {
            target: "simpanSoal",
            id: document.getElementById('edit-id').value || null,
            mapel: document.getElementById('mapel-guru').value,
            kelas: kls,
            soal: document.getElementById('pertanyaan').value,
            a: document.getElementById('opsi-a').value,
            b: document.getElementById('opsi-b').value,
            c: document.getElementById('opsi-c').value,
            d: document.getElementById('opsi-d').value,
            kunci: document.getElementById('kunci-jawaban').value
        };
        
        if(!kls || !payload.soal || !payload.mapel) return Swal.fire("Wajib", "Mapel, Kelas, dan Soal harus diisi!", "warning");

        Swal.fire({title:'Memproses...', didOpen:()=>Swal.showLoading(), allowOutsideClick: false});
        
        try {
            await fetch(SCRIPT_URL, {method:'POST', body:JSON.stringify(payload)});
            Swal.fire({icon: 'success', title: 'Tersimpan', timer: 1000, showConfirmButton: false});
            bersihkanForm();
        } catch(e) { Swal.fire("Error", "Gagal menyimpan", "error"); }
    }

    function bersihkanForm() {
        document.getElementById('edit-id').value = "";
        document.getElementById('pertanyaan').value = "";
        document.getElementById('opsi-a').value = "";
        document.getElementById('opsi-b').value = "";
        document.getElementById('opsi-c').value = "";
        document.getElementById('opsi-d').value = "";
        document.getElementById('form-title').innerText = "üìù Input Soal";
        document.getElementById('btn-submit').innerText = "SIMPAN DATA";
        document.getElementById('btn-batal').style.display = "none";
        document.querySelectorAll('.kelas-opt').forEach(cb => cb.checked = false);
        updateLabelKelas();
    }

    async function muatDaftarSoal() {
        const wadah = document.getElementById('wadah-daftar-soal');
        wadah.innerHTML = "Memuat...";
        const res = await fetch(`${SCRIPT_URL}?target=listSemuaSoal`);
        const data = await res.json();
        let html = `<table><tr><th>Mapel</th><th>Kelas</th><th>Soal</th><th>Aksi</th></tr>`;
        data.forEach(s => {
            html += `<tr>
                <td>${s.mapel}</td>
                <td><small>${s.kelas}</small></td>
                <td>${s.soal.substring(0,30)}...</td>
                <td>
                    <button class="btn-icon btn-edit" onclick='siapkanEdit(${JSON.stringify(s).replace(/'/g, "&apos;")})'><i class="fas fa-edit"></i></button>
                    <button class="btn-icon btn-delete" onclick="hapusData('hapusSoal', '${s.id}')"><i class="fas fa-trash"></i></button>
                </td>
            </tr>`;
        });
        wadah.innerHTML = html + "</table>";
    }

    function siapkanEdit(s) {
        bersihkanForm();
        document.getElementById('edit-id').value = s.id;
        document.getElementById('pertanyaan').value = s.soal;
        document.getElementById('mapel-guru').value = s.mapel;
        document.getElementById('opsi-a').value = s.a;
        document.getElementById('opsi-b').value = s.b;
        document.getElementById('opsi-c').value = s.c;
        document.getElementById('opsi-d').value = s.d;
        document.getElementById('kunci-jawaban').value = s.kunci;
        const klsArr = s.kelas.split(',');
        document.querySelectorAll('.kelas-opt').forEach(cb => { if(klsArr.includes(cb.value)) cb.checked = true; });
        updateLabelKelas();
        document.getElementById('form-title').innerText = "‚úèÔ∏è Edit Soal";
        document.getElementById('btn-submit').innerText = "PERBARUI DATA";
        document.getElementById('btn-batal').style.display = "block";
        showSection('buat-soal', document.getElementById('nav-input'));
    }

    async function muatRekapNilai() {
        const wadah = document.getElementById('wadah-rekap');
        wadah.innerHTML = "Memuat...";
        const res = await fetch(`${SCRIPT_URL}?target=getRekapNilai`);
        const data = await res.json();
        let html = `<table><tr><th>Waktu</th><th>Nama</th><th>Skor</th><th>Hapus</th></tr>`;
        data.forEach(n => {
            html += `<tr><td><small>${n.waktu}</small></td><td>${n.nama}</td><td><b>${n.skor}</b></td>
                <td><button class="btn-icon btn-delete" onclick="hapusData('hapusNilai', '${n.id}')"><i class="fas fa-trash-can"></i></button></td></tr>`;
        });
        wadah.innerHTML = html + "</table>";
    }

    async function hapusData(target, id) {
        const confirm = await Swal.fire({ title: 'Hapus?', text: 'Data akan hilang permanen!', icon: 'warning', showCancelButton: true });
        if(confirm.isConfirmed) {
            Swal.fire({title:'Menghapus...', didOpen:()=>Swal.showLoading()});
            await fetch(SCRIPT_URL, {method:'POST', body:JSON.stringify({target:target, id:id})});
            target === 'hapusSoal' ? muatDaftarSoal() : muatRekapNilai();
            Swal.fire("Terhapus", "", "success");
        }
    }

    window.onclick = function(e) { if (!e.target.closest('.multiselect')) document.getElementById("checkboxes-kelas").style.display = "none"; }
</script>
</body>
</html>